<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ƒê·∫∑t V√© Xe Tr·ª±c Tuy·∫øn</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- App Styles -->
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- N√∫t Admin (·∫©n, ch·ªâ hi·ªán khi role = admin) -->
    <a id="adminLink" href="admin.html" class="btn btn-warning rounded-pill px-3 d-none">Admin</a>
    <a id="employeeLink" href="employee.html" class="btn btn-info rounded-pill px-3 d-none">Nh√¢n vi√™n</a>

    <!-- Header / Navbar -->
    <header class="bg-primary text-white p-3">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- Logo + Brand -->
            <div class="left-section d-flex align-items-center">
                <a href="#top" class="brand-logo" aria-label="V·ªÅ ƒë·∫ßu trang">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSdk1KSWlpLDRMeHJM6uZpOhHTWgzEzgDuU6ZKf1go82QKatnJwwUWcGVz3nC1JHMUHa34&usqp=CAU" class="logo" alt="Logo Du L·ªãch Ba Duy">
                </a>
                <h1 class="m-0 brand-title">Du L·ªãch Ba Duy</h1>
            </div>

            <!-- User / Actions -->
            <div id="userSection" class="right-section d-flex align-items-center gap-2">
                <!-- Tra c·ª©u v√© -->
                <a href="check-booking.html" class="btn btn-primary rounded-pill px-3 text-white">Tra c·ª©u v√©</a>

                <!-- Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng sau khi ƒëƒÉng nh·∫≠p -->
                <span id="userName" class="me-2 fw-bold text-white d-none"></span>

                <!-- ƒêƒÉng xu·∫•t -->
                <button id="logoutBtn" class="btn btn-danger rounded-pill px-3 d-none" type="button">ƒêƒÉng Xu·∫•t</button>

                <!-- ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω (khi ch∆∞a ƒëƒÉng nh·∫≠p) -->
                <a id="loginBtn" href="login.html" class="btn btn-primary rounded-pill px-3">ƒêƒÉng Nh·∫≠p</a>
                <a id="registerBtn" href="register.html" class="btn btn-success rounded-pill px-3">ƒêƒÉng K√Ω</a>

                <!-- Hotline dropdown -->
                <div class="dropdown">
                    <button class="btn btn-light rounded-pill d-flex align-items-center gap-2 px-4 py-2" type="button" id="hotlineDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 1.1rem; font-weight: 600;">
            <img src="https://cdn-icons-png.freepik.com/512/3488/3488550.png" alt="Phone Icon" width="28" height="28"
              class="rounded-circle bg-white p-1 shadow-sm" style="object-fit:contain;">
            Hotline 24/7
          </button>

                    <ul class="dropdown-menu p-3" aria-labelledby="hotlineDropdown" style="min-width:280px;">
                        <li>
                            <a class="dropdown-item" href="tel:0123456789">
                                <div class="fw-bold">0123456789</div>
                                <small class="text-muted">Ph·∫£n h·ªìi d·ªãch v·ª• & x·ª≠ l√Ω s·ª± c·ªë</small>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="tel:0123456789">
                                <div class="fw-bold">0123456789</div>
                                <small class="text-muted">ƒê·∫∑t v√© qua ƒëi·ªán tho·∫°i (24/7)</small>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Banner -->
    <section class="banner text-center d-flex align-items-center justify-content-center">
        <div class="banner-overlay"></div>
        <div class="banner-content">
            <h2 class="display-5 display-md-4">ƒê·∫∑t V√© Xe Tr·ª±c Tuy·∫øn Nhanh Ch√≥ng</h2>
            <p class="lead">T√¨m chuy·∫øn d·ªÖ d√†ng ¬∑ Gi√° v√© minh b·∫°ch ¬∑ Thanh to√°n an to√†n</p>

            <a href="#searchSection" class="btn btn-warning btn-lg mt-3">ƒê·∫∑t V√© Ngay</a>
        </div>
    </section>

    <!-- Search Box -->
    <section class="search-section py-5" id="searchSection">
        <div class="container">
            <h2 class="text-center mb-4 text-primary section-title">T√¨m Ki·∫øm Chuy·∫øn Xe</h2>
            <div class="search-box p-4 rounded-3 shadow-sm bg-white">
                <form id="searchForm" class="row g-3 align-items-end justify-content-center">
                    <!-- Tuy·∫øn ƒë∆∞·ªùng -->
                    <div class="col-md-3">
                        <label for="route" class="form-label"><strong>Ch·ªçn tuy·∫øn ƒë∆∞·ªùng</strong></label>
                        <select id="route" class="form-select" required>
              <option value="">Ch·ªçn tuy·∫øn ƒë∆∞·ªùng</option>
              <option value="Lagi - TP. H·ªì Ch√≠ Minh">Lagi - TP. H·ªì Ch√≠ Minh</option>
              <option value="Lagi - ƒê√† L·∫°t">Lagi - ƒê√† L·∫°t</option>
              <option value="Lagi - Nha Trang">Lagi - Nha Trang</option>
            </select>
                    </div>
                    <!-- ƒêi·ªÉm ƒë√≥n -->
                    <div class="col-md-3">
                        <label for="departure" class="form-label"><strong>ƒêi·ªÉm ƒë√≥n</strong></label>
                        <input type="text" id="departure" class="form-control" placeholder="Ch·ªçn ƒëi·ªÉm ƒë√≥n" list="pickupPoints" required>
                        <datalist id="pickupPoints"></datalist>
                    </div>
                    <!-- ƒêi·ªÉm ƒë·∫øn -->
                    <div class="col-md-3">
                        <label for="destination" class="form-label"><strong>ƒêi·ªÉm ƒë·∫øn</strong></label>
                        <input type="text" id="destination" class="form-control" placeholder="Ch·ªçn ƒëi·ªÉm ƒë·∫øn" list="dropOffPoints" required>
                        <datalist id="dropOffPoints"></datalist>
                    </div>
                    <!-- Ng√†y ƒëi -->
                    <div class="col-md-3">
                        <label for="date" class="form-label"><strong>Ng√†y ƒëi</strong></label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    <!-- Button t√¨m -->
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-find-trip w-100">T√¨m chuy·∫øn xe</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Trip Results -->
    <section class="trip-list py-5">
        <div class="container">
            <h2 class="text-center text-primary section-title">Danh S√°ch Chuy·∫øn Xe</h2>

            <div id="tripResults">
                <div class="trip-group">
                    <div class="trip-group__header">
                        <span class="dot dot--go"></span>
                        <h3>Chi·ªÅu ƒëi</h3>
                    </div>
                    <div id="outboundResults" class="trip-grid"></div>
                </div>

                <div class="trip-group">
                    <div class="trip-group__header">
                        <span class="dot dot--back"></span>
                        <h3>Chi·ªÅu v·ªÅ</h3>
                    </div>
                    <div id="returnResults" class="trip-grid"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Seat Modal -->
    <div class="modal fade" id="seatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <!-- header + 5 b∆∞·ªõc -->
                <div class="modal-header flex-column align-items-start gap-2">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h5 class="modal-title mb-0">Ch·ªçn gh·∫ø (15 ch·ªó)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <!-- thanh 5 b∆∞·ªõc -->
                    <div class="d-flex align-items-center flex-wrap gap-2" style="font-size:.72rem">
                        <!-- B1 -->
                        <div class="d-flex align-items-center gap-1">
                            <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:26px;height:26px;background:rgba(10,160,110,.12);color:#0f766e;font-weight:600;">
                1
              </span>
                            <span class="text-success fw-semibold">Ch·ªçn chuy·∫øn</span>
                        </div>
                        <span style="width:32px;height:2px;background:rgba(148,163,184,.35);"></span>
                        <!-- B2 (active) -->
                        <div class="d-flex align-items-center gap-1">
                            <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:26px;height:26px;background:#0A5AD7;color:white;font-weight:700;box-shadow:0 4px 10px rgba(10,90,215,.3);">
                2
              </span>
                            <span class="fw-semibold" style="color:#0f172a;">Ch·ªçn gh·∫ø</span>
                        </div>
                        <span style="width:32px;height:2px;background:rgba(148,163,184,.35);"></span>
                        <!-- B3 -->
                        <div class="d-flex align-items-center gap-1 text-muted">
                            <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:26px;height:26px;background:#e2e8f0;color:#475569;font-weight:600;">
                3
              </span>
                            <span>Th√¥ng tin</span>
                        </div>
                        <span style="width:32px;height:2px;background:rgba(148,163,184,.35);"></span>
                        <!-- B4 -->
                        <div class="d-flex align-items-center gap-1 text-muted">
                            <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:26px;height:26px;background:#e2e8f0;color:#475569;font-weight:600;">
                4
              </span>
                            <span>Thanh to√°n</span>
                        </div>
                        <span style="width:32px;height:2px;background:rgba(148,163,184,.35);"></span>
                        <!-- B5 -->
                        <div class="d-flex align-items-center gap-1 text-muted">
                            <span class="rounded-circle d-inline-flex justify-content-center align-items-center" style="width:26px;height:26px;background:#e2e8f0;color:#475569;font-weight:600;">
                5
              </span>
                            <span>Ho√†n t·∫•t</span>
                        </div>
                    </div>
                </div>

                <div class="modal-body">
                    <div id="seatMeta" class="mb-2 text-muted"></div>
                    <div id="seatGrid" class="d-flex flex-column gap-2"></div>
                    <div class="mt-3 d-flex align-items-center justify-content-between">
                        <div>
                            <span class="badge bg-secondary me-2">Tr·ªëng</span>
                            <span class="badge bg-warning text-dark me-2">ƒêang gi·ªØ</span>
                            <span class="badge bg-danger me-2">ƒê√£ b√°n</span>
                            <span class="badge bg-primary">ƒê√£ ch·ªçn</span>
                        </div>
                        <button id="btnHold" class="btn btn-primary" disabled>Ti·∫øp t·ª•c</button>
                    </div>
                    <div id="seatMsg" class="mt-2 small text-muted"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- ====== B·∫ÆT ƒê·∫¶U KH·ªêI ƒê√ÅNH GI√Å D·ªäCH V·ª§ ====== -->
    <section class="reviews-wrapper" id="reviewsSection">
        <div class="reviews-grid">
            <!-- C·ªòT TR√ÅI: T·ªîNG H·ª¢P + DANH S√ÅCH -->
            <div class="reviews-left">
                <!-- T·ªïng quan rating -->
                <div class="rating-summary-card">
                    <div class="rating-score">
                        <span id="ratingAverage">0.0</span>
                        <div class="rating-stars" id="ratingSummaryStars">
                            <!-- sao s·∫Ω render b·∫±ng JS -->
                        </div>
                        <p class="rating-label">ƒêi·ªÉm trung b√¨nh</p>
                    </div>
                    <div class="rating-meta">
                        <p class="rating-count">
                            <span id="ratingCount">0</span> l∆∞·ª£t ƒë√°nh gi√°
                        </p>
                        <p class="rating-note">
                            T·ª´ nh·ªØng kh√°ch ƒë√£ ƒë·∫∑t v√© v√† ho√†n t·∫•t chuy·∫øn ƒëi.
                        </p>
                    </div>
                </div>

                <!-- Header danh s√°ch + filter -->
                <div class="reviews-list-header">
                    <div class="reviews-list-header-left">
                        <h3>√ù ki·∫øn t·ª´ kh√°ch h√†ng</h3>
                        <span id="reviewsListCountBadge" class="pill-badge">0 ƒë√°nh gi√°</span>
                    </div>
                    <div class="reviews-list-header-right">
                        <select id="reviewsStarFilter" class="reviews-filter-select">
            <option value="0">T·∫•t c·∫£ s·ªë sao</option>
            <option value="5">Ch·ªâ 5 sao</option>
            <option value="4">T·ª´ 4 sao tr·ªü l√™n</option>
            <option value="3">T·ª´ 3 sao tr·ªü l√™n</option>
            <option value="2">T·ª´ 2 sao tr·ªü l√™n</option>
            <option value="1">T·∫•t c·∫£ (1+)</option>
          </select>
                        <button type="button" id="reviewsToggleBtn" class="reviews-toggle-btn">
            Xem t·∫•t c·∫£
          </button>
                    </div>
                </div>

                <!-- Danh s√°ch ƒë√°nh gi√° -->
                <div id="reviewsList" class="reviews-list"></div>
                <div id="reviewsEmpty" class="reviews-empty" style="display:none;">
                    Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n!
                </div>
            </div>

            <!-- C·ªòT PH·∫¢I: FORM G·ª¨I ƒê√ÅNH GI√Å -->
            <div class="reviews-right">
                <h2 class="review-title">Chia s·∫ª tr·∫£i nghi·ªám chuy·∫øn ƒëi</h2>
                <p class="review-subtitle">
                    ƒê√°nh gi√° gi√∫p Ba Duy Bus c·∫£i thi·ªán ch·∫•t l∆∞·ª£ng ph·ª•c v·ª•. Ch·ªâ kh√°ch ƒë√£ t·ª´ng ƒë·∫∑t v√© b·∫±ng s·ªë ƒëi·ªán tho·∫°i n√†y m·ªõi g·ª≠i ƒë∆∞·ª£c ƒë√°nh gi√°.
                </p>

                <form id="reviewForm" class="review-form">
                    <!-- S·ªê ƒêI·ªÜN THO·∫†I -->
                    <div class="form-group">
                        <label for="rvPhone">S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë·∫∑t v√© <span class="required">*</span></label>
                        <input type="tel" id="rvPhone" class="form-control" placeholder="VD: 0347 448 344" maxlength="15" />
                        <small class="form-text-muted">
            H·ªá th·ªëng s·∫Ω ki·ªÉm tra xem s·ªë n√†y ƒë√£ t·ª´ng ƒë·∫∑t v√† ho√†n t·∫•t v√© hay ch∆∞a.
          </small>
                    </div>

                    <!-- ƒê√ÅNH GI√Å SAO -->
                    <div class="form-group">
                        <label>Ch·∫•t l∆∞·ª£ng d·ªãch v·ª• <span class="required">*</span></label>
                        <div class="rating-input">
                            <input type="radio" id="star5" name="rating" value="5" checked />
                            <label for="star5" title="R·∫•t h√†i l√≤ng">‚òÖ</label>

                            <input type="radio" id="star4" name="rating" value="4" />
                            <label for="star4" title="H√†i l√≤ng">‚òÖ</label>

                            <input type="radio" id="star3" name="rating" value="3" />
                            <label for="star3" title="B√¨nh th∆∞·ªùng">‚òÖ</label>

                            <input type="radio" id="star2" name="rating" value="2" />
                            <label for="star2" title="Ch∆∞a t·ªët">‚òÖ</label>

                            <input type="radio" id="star1" name="rating" value="1" />
                            <label for="star1" title="T·ªá">‚òÖ</label>
                        </div>
                    </div>

                    <!-- N·ªòI DUNG NH·∫¨N X√âT -->
                    <div class="form-group">
                        <label for="rvComment">Nh·∫≠n x√©t c·ªßa b·∫°n <span class="required">*</span></label>
                        <textarea id="rvComment" class="form-control" rows="4" placeholder="Chia s·∫ª tr·∫£i nghi·ªám chuy·∫øn ƒëi c·ªßa b·∫°n..."></textarea>
                    </div>

                    <button type="submit" id="btnSubmitReview" class="btn-primary w-100">
          G·ª≠i ƒë√°nh gi√°
        </button>

                    <div id="reviewMessage" class="review-message" style="display:none;"></div>
                </form>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary text-white text-center p-3">
        &copy; Nh√† Xe Ba Duy.
    </footer>

    <!-- Bootstrap JS (bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- App JS -->
<script src="script.js"></script>

<!-- Script x·ª≠ l√Ω ƒëƒÉng nh·∫≠p / logout / hi·ªÉn th·ªã Admin -->
<script>
    (function() {
        const API_BASE = 'https://webdatve.onrender.com';
        const userNameEl = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const adminLink = document.getElementById('adminLink');
        const employeeLink = document.getElementById('employeeLink');

        function getUser() {
            try {
                return JSON.parse(localStorage.getItem('user') || 'null');
            } catch {
                return null;
            }
        }

        function renderAuthUI() {
            var user = getUser();
            if (user && user.username) {
                userNameEl.textContent = 'üëã Xin ch√†o, ' + user.username;
                userNameEl.classList.remove('d-none');
                logoutBtn.classList.remove('d-none');
                if (loginBtn) loginBtn.classList.add('d-none');
                if (registerBtn) registerBtn.classList.add('d-none');

                if (user.role === 'admin') {
                    if (adminLink) adminLink.classList.remove('d-none');
                    if (employeeLink) employeeLink.classList.remove('d-none');
                } else if (user.role === 'employee') {
                    if (adminLink) adminLink.classList.add('d-none');
                    if (employeeLink) employeeLink.classList.remove('d-none');
                } else {
                    if (adminLink) adminLink.classList.add('d-none');
                    if (employeeLink) employeeLink.classList.add('d-none');
                }

            } else {
                userNameEl.classList.add('d-none');
                logoutBtn.classList.add('d-none');
                if (loginBtn) loginBtn.classList.remove('d-none');
                if (registerBtn) registerBtn.classList.remove('d-none');
                if (adminLink) adminLink.classList.add('d-none');
                if (employeeLink) employeeLink.classList.add('d-none');
            }
        }

        async function validateToken() {
            var token = localStorage.getItem('token');
            if (!token) return;
            try {
                var res = await fetch(API_BASE + '/api/auth/me', {
                    headers: {
                        Authorization: 'Bearer ' + token
                    },
                    credentials: 'include'
                });
                if (res.ok) {
                    var data = await res.json();
                    localStorage.setItem('user', JSON.stringify(data));
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            } catch (err) {
                console.warn('Token check error', err);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                try {
                    await fetch(API_BASE + '/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    }).catch(function() {});
                } finally {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    renderAuthUI();
                    location.reload();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async() => {
            await validateToken();
            renderAuthUI();
        });

        window.addEventListener('storage', (e) => {
            if (e.key === 'user' || e.key === 'token') renderAuthUI();
        });
    })();
</script>

<!-- Chat box kh√°ch h√†ng: d√πng REST /api/chat -->
<script>
    const CHAT_API_BASE = 'https://webdatve.onrender.com'; // backend online

    (function() {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
<!-- N√∫t m·ªü l·∫°i chat (khi ƒë√≥ng) -->
<button id="chatOpenBtn" style="
  position:fixed; right:20px; bottom:20px;
  width:60px; height:60px; border-radius:50%;
  border:none; background:#0d6efd; color:white;
  display:none; justify-content:center; align-items:center;
  font-size:26px; box-shadow:0 4px 12px rgba(0,0,0,.25);
  z-index:99999; cursor:pointer;
">
  üí¨
</button>

<!-- H·ªôp chat -->
<div id="chatBox" style="
  position:fixed; right:20px; bottom:20px;
  width:330px; height:440px;
  background:#fff; border-radius:14px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  display:flex; flex-direction:column;
  overflow:hidden; z-index:99999;
">
  <div id="chatHeader" style="
    background:#0d6efd; color:white;
    padding:10px 14px; display:flex;
    justify-content:space-between;
    align-items:center; font-weight:bold;
  ">
    <span>H·ªó tr·ª£ ƒë·∫∑t v√©</span>
    <button id="chatClose"
      style="border:none;background:transparent;color:white;font-size:18px;font-weight:bold;cursor:pointer;">
      √ó
    </button>
  </div>

  <div id="chatMessages" style="
    flex:1; padding:8px; overflow-y:auto;
    background:#f7f7f7;
  "></div>

  <div id="chatInputWrap" style="display:flex;border-top:1px solid #ccc;">
    <input id="chatInput"
      style="flex:1;border:none;padding:10px;"
      placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button id="chatSend"
      style="background:#0d6efd;color:white;border:none;padding:10px 14px;">
      G·ª≠i
    </button>
  </div>
</div>
`;
        document.body.appendChild(wrapper);

        const chatBox = document.getElementById('chatBox');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatClose = document.getElementById('chatClose');
        const chatOpenBtn = document.getElementById('chatOpenBtn');

        // ===== ƒê√ìNG CHATBOX (√ó) -> hi·ªán n√∫t üí¨ =====
        chatClose.onclick = () => {
            chatBox.style.display = 'none';
            chatOpenBtn.style.display = 'flex';
        };

        // ===== M·ªû L·∫†I CHATBOX T·ª™ N√öT üí¨ =====
        chatOpenBtn.onclick = (e) => {
            // N·∫øu v·ª´a k√©o th√¨ kh√¥ng m·ªü chat khi th·∫£ chu·ªôt
            if (chatOpenBtn.__dragging) return;

            chatBox.style.display = 'flex';
            chatOpenBtn.style.display = 'none';
        };

        // ===== K√âO TH·∫¢ N√öT üí¨ + SNAP 12 V·ªä TR√ç =====
        (function makeDraggable(btn) {
            let isDown = false;
            let offsetX = 0;
            let offsetY = 0;

            // T·∫°o 12 v·ªã tr√≠ snap (theo k√≠ch th∆∞·ªõc m√†n h√¨nh hi·ªán t·∫°i)
            function getSnapPositions() {
                const margin = 10;
                const w = btn.offsetWidth;
                const h = btn.offsetHeight;

                const maxX = window.innerWidth - w - margin;
                const maxY = window.innerHeight - h - margin;

                const midX = (window.innerWidth - w) / 2;
                const midY = (window.innerHeight - h) / 2;

                const quarterX = (window.innerWidth - w) / 4;
                const threeQX = 3 * (window.innerWidth - w) / 4;

                return [
                    // 6 v·ªã tr√≠ c·∫°nh tr√°i / ph·∫£i (tr√™n ‚Äì gi·ªØa ‚Äì d∆∞·ªõi)
                    { left: margin, top: margin },
                    { left: margin, top: midY },
                    { left: margin, top: maxY },

                    { left: maxX, top: margin },
                    { left: maxX, top: midY },
                    { left: maxX, top: maxY },

                    // 6 v·ªã tr√≠ c·∫°nh tr√™n / d∆∞·ªõi (4 ƒëi·ªÉm chia ƒë·ªÅu + 2 gi·ªØa)
                    { left: quarterX, top: margin },
                    { left: midX, top: margin },
                    { left: threeQX, top: margin },

                    { left: quarterX, top: maxY },
                    { left: midX, top: maxY },
                    { left: threeQX, top: maxY },
                ];
            }

            function snapToNearest() {
                const rect = btn.getBoundingClientRect();
                const w = btn.offsetWidth;
                const h = btn.offsetHeight;

                const centerX = rect.left + w / 2;
                const centerY = rect.top + h / 2;

                const positions = getSnapPositions();
                let best = positions[0];
                let minDist = Infinity;

                for (let i = 0; i < positions.length; i++) {
                    const p = positions[i];
                    const cx = p.left + w / 2;
                    const cy = p.top + h / 2;
                    const d = (cx - centerX) * (cx - centerX) + (cy - centerY) * (cy - centerY);
                    if (d < minDist) {
                        minDist = d;
                        best = p;
                    }
                }

                btn.style.left = best.left + 'px';
                btn.style.top = best.top + 'px';
            }

            function startDrag(clientX, clientY) {
                isDown = true;
                btn.__dragging = true;

                // chuy·ªÉn t·ª´ right/bottom sang left/top n·∫øu ch∆∞a c√≥
                if (!btn.style.left && !btn.style.top) {
                    const rect = btn.getBoundingClientRect();
                    btn.style.left = rect.left + 'px';
                    btn.style.top = rect.top + 'px';
                    btn.style.right = 'auto';
                    btn.style.bottom = 'auto';
                }

                offsetX = clientX - btn.offsetLeft;
                offsetY = clientY - btn.offsetTop;
            }

            function doDrag(clientX, clientY) {
                if (!isDown) return;

                let x = clientX - offsetX;
                let y = clientY - offsetY;

                const margin = 4;
                const maxX = window.innerWidth - btn.offsetWidth - margin;
                const maxY = window.innerHeight - btn.offsetHeight - margin;

                if (x < margin) x = margin;
                if (y < margin) y = margin;
                if (x > maxX) x = maxX;
                if (y > maxY) y = maxY;

                btn.style.left = x + 'px';
                btn.style.top = y + 'px';
            }

            function endDrag() {
                if (!isDown) return;
                isDown = false;
                snapToNearest(); // <- h√∫t v·ªÅ v·ªã tr√≠ g·∫ßn nh·∫•t

                // Sau 150ms cho ph√©p click l·∫°i b√¨nh th∆∞·ªùng
                setTimeout(() => {
                    btn.__dragging = false;
                }, 150);
            }

            // Chu·ªôt
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e.clientX, e.clientY);
            });
            document.addEventListener('mousemove', (e) => {
                doDrag(e.clientX, e.clientY);
            });
            document.addEventListener('mouseup', () => {
                endDrag();
            });

            // C·∫£m ·ª©ng
            btn.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                startDrag(t.clientX, t.clientY);
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const t = e.touches[0];
                doDrag(t.clientX, t.clientY);
            }, { passive: false });

            document.addEventListener('touchend', () => {
                endDrag();
            });
        })(chatOpenBtn);


        // ===== HI·ªÇN TH·ªä MESSAGE TRONG KHUNG CHAT =====
        function addMsg(text, mine = false) {
            const div = document.createElement('div');
            div.style.margin = '6px 0';
            div.style.textAlign = mine ? 'right' : 'left';
            div.innerHTML = `
<span style="
  display:inline-block; padding:8px 12px;
  border-radius:12px; max-width:75%;
  white-space:pre-line;
  background:${mine ? '#0d6efd' : '#e9e9e9'};
  color:${mine ? 'white' : 'black'};
">${text}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ===== G·ª¨I TIN NH·∫ÆN L√äN BACKEND =====
        async function sendChat() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMsg(text, true);
            chatInput.value = '';

            try {
                const res = await fetch(CHAT_API_BASE + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    addMsg('‚ö†Ô∏è L·ªói server, vui l√≤ng th·ª≠ l·∫°i sau.');
                    return;
                }
                addMsg(data.reply || '(Bot kh√¥ng tr·∫£ l·ªùi)');
            } catch (err) {
                console.error('Chat error:', err);
                addMsg('‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.');
            }
        }

        chatSend.onclick = sendChat;
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // L·ªùi ch√†o m·∫∑c ƒë·ªãnh
        addMsg('ü§ñ Bot: Xin ch√†o! B·∫°n c√≥ th·ªÉ h·ªèi: "Gi√° v√© Lagi ƒëi ƒê√† L·∫°t ng√†y mai?", "Gi·ªù ch·∫°y Lagi ‚Äì HCM h√¥m nay?" ...');
    })();
</script>

</body>
</html>
