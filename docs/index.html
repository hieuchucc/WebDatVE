<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ƒê·∫∑t V√© Xe Tr·ª±c Tuy·∫øn</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- App Styles -->
    <link rel="stylesheet" href="style.css">

    <!-- ===== TH√äM CSS BANNER (C√ÅCH 1 ‚Äì DUY NH·∫§T) ===== -->
    <style>
        .banner {
            background: url('https://img1.oto.com.vn/2024/01/18/solati-a40c-e915_wm.webp') center / cover no-repeat;
            min-height: 520px;
            position: relative;
            color: #fff;
        }

        .banner-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1;
        }

        .banner-content {
            position: relative;
            z-index: 2;
        }
    </style>
</head>

<body id="top">

    <!-- N√∫t Admin -->
    <a id="adminLink" href="admin.html" class="btn btn-warning rounded-pill px-3 d-none">Admin</a>
    <a id="employeeLink" href="employee.html" class="btn btn-info rounded-pill px-3 d-none">Nh√¢n vi√™n</a>

    <!-- Header -->
    <header class="bg-primary text-white p-3">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="#top">
                    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSdk1KSWlpLDRMeHJM6uZpOhHTWgzEzgDuU6ZKf1go82QKatnJwwUWcGVz3nC1JHMUHa34&usqp=CAU"
                        height="48" class="me-2">
                </a>
                <h1 class="h4 m-0">Du L·ªãch Ba Duy</h1>
            </div>

            <div class="d-flex align-items-center gap-2">
                <a href="check-booking.html" class="btn btn-light rounded-pill">Tra c·ª©u v√©</a>
                <span id="userName" class="fw-bold text-white d-none"></span>
                <button id="logoutBtn" class="btn btn-danger rounded-pill d-none" type="button">ƒêƒÉng xu·∫•t</button>
                <a id="loginBtn" href="login.html" class="btn btn-outline-light rounded-pill">ƒêƒÉng nh·∫≠p</a>
                <a id="registerBtn" href="register.html" class="btn btn-warning rounded-pill">ƒêƒÉng k√Ω</a>
            </div>
        </div>
    </header>

    <!-- ===== BANNER (GI·ªÆ HTML C≈®) ===== -->
    <section class="banner text-center d-flex align-items-center justify-content-center">
        <div class="banner-overlay"></div>
        <div class="banner-content">
            <h2 class="display-5 fw-bold">ƒê·∫∑t V√© Xe Tr·ª±c Tuy·∫øn Nhanh Ch√≥ng</h2>
            <p class="lead">T√¨m chuy·∫øn d·ªÖ d√†ng ¬∑ Gi√° v√© minh b·∫°ch ¬∑ Thanh to√°n an to√†n</p>
            <a href="#searchSection" class="btn btn-warning btn-lg mt-3">ƒê·∫∑t V√© Ngay</a>
        </div>
    </section>

    <!-- ===== SEARCH ===== -->
    <section class="search-section py-5" id="searchSection">
        <div class="container">
            <h2 class="text-center mb-4 text-primary">T√¨m Ki·∫øm Chuy·∫øn Xe</h2>
            <form id="searchForm" class="row g-3 align-items-end justify-content-center">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Tuy·∫øn</label>
                    <select id="route" class="form-select">
                        <option value="">Ch·ªçn tuy·∫øn</option>
                        <option>Lagi - TP. H·ªì Ch√≠ Minh</option>
                        <option>Lagi - ƒê√† L·∫°t</option>
                        <option>Lagi - Nha Trang</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ƒêi·ªÉm ƒë√≥n</label>
                    <input id="departure" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">ƒêi·ªÉm ƒë·∫øn</label>
                    <input id="destination" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Ng√†y ƒëi</label>
                    <input type="date" id="date" class="form-control">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100">T√¨m chuy·∫øn</button>
                </div>
            </form>
        </div>
    </section>

    <!-- ===== DANH S√ÅCH CHUY·∫æN ===== -->
    <section class="trip-list py-5">
        <div class="container">
            <h2 class="text-center text-primary">Danh S√°ch Chuy·∫øn Xe</h2>
            <div id="outboundResults"></div>
            <div id="returnResults"></div>
        </div>
    </section>

    <!-- ===== MODAL GH·∫æ ===== -->
    <div class="modal fade" id="seatModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ch·ªçn gh·∫ø</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="seatGrid"></div>
                    <button id="btnHold" class="btn btn-primary mt-3" disabled>Ti·∫øp t·ª•c</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== REVIEW ===== -->
    <section class="reviews-wrapper" id="reviewsSection">
        <div class="container py-5">
            <h2 class="text-center">ƒê√°nh gi√° d·ªãch v·ª•</h2>
            <div id="reviewsList"></div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary text-white text-center p-3">
        &copy; Nh√† Xe Ba Duy
    </footer>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App JS -->
    <script src="script.js"></script>

<!-- Script x·ª≠ l√Ω ƒëƒÉng nh·∫≠p / logout / hi·ªÉn th·ªã Admin -->
<script>
    (function() {
        const API_BASE = 'https://webdatve.onrender.com';
        const userNameEl = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const adminLink = document.getElementById('adminLink');
        const employeeLink = document.getElementById('employeeLink');

        function getUser() {
            try {
                return JSON.parse(localStorage.getItem('user') || 'null');
            } catch {
                return null;
            }
        }

        function renderAuthUI() {
            var user = getUser();
            if (user && user.username) {
                userNameEl.textContent = 'üëã Xin ch√†o, ' + user.username;
                userNameEl.classList.remove('d-none');
                logoutBtn.classList.remove('d-none');
                if (loginBtn) loginBtn.classList.add('d-none');
                if (registerBtn) registerBtn.classList.add('d-none');

                if (user.role === 'admin') {
                    if (adminLink) adminLink.classList.remove('d-none');
                    if (employeeLink) employeeLink.classList.remove('d-none');
                } else if (user.role === 'employee') {
                    if (adminLink) adminLink.classList.add('d-none');
                    if (employeeLink) employeeLink.classList.remove('d-none');
                } else {
                    if (adminLink) adminLink.classList.add('d-none');
                    if (employeeLink) employeeLink.classList.add('d-none');
                }

            } else {
                userNameEl.classList.add('d-none');
                logoutBtn.classList.add('d-none');
                if (loginBtn) loginBtn.classList.remove('d-none');
                if (registerBtn) registerBtn.classList.remove('d-none');
                if (adminLink) adminLink.classList.add('d-none');
                if (employeeLink) employeeLink.classList.add('d-none');
            }
        }

        async function validateToken() {
            var token = localStorage.getItem('token');
            if (!token) return;
            try {
                var res = await fetch(API_BASE + '/api/auth/me', {
                    headers: {
                        Authorization: 'Bearer ' + token
                    },
                    credentials: 'include'
                });
                if (res.ok) {
                    var data = await res.json();
                    localStorage.setItem('user', JSON.stringify(data));
                } else {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
            } catch (err) {
                console.warn('Token check error', err);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
            }
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', async function() {
                try {
                    await fetch(API_BASE + '/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include'
                    }).catch(function() {});
                } finally {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    renderAuthUI();
                    location.reload();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async() => {
            await validateToken();
            renderAuthUI();
        });

        window.addEventListener('storage', (e) => {
            if (e.key === 'user' || e.key === 'token') renderAuthUI();
        });
    })();
</script>

<!-- Chat box kh√°ch h√†ng: d√πng REST /api/chat -->
<script>
    const CHAT_API_BASE = 'https://webdatve.onrender.com'; // backend online

    (function() {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
<!-- N√∫t m·ªü l·∫°i chat (khi ƒë√≥ng) -->
<button id="chatOpenBtn" style="
  position:fixed; right:20px; bottom:20px;
  width:60px; height:60px; border-radius:50%;
  border:none; background:#0d6efd; color:white;
  display:none; justify-content:center; align-items:center;
  font-size:26px; box-shadow:0 4px 12px rgba(0,0,0,.25);
  z-index:99999; cursor:pointer;
">
  üí¨
</button>

<!-- H·ªôp chat -->
<div id="chatBox" style="
  position:fixed; right:20px; bottom:20px;
  width:330px; height:440px;
  background:#fff; border-radius:14px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
  display:flex; flex-direction:column;
  overflow:hidden; z-index:99999;
">
  <div id="chatHeader" style="
    background:#0d6efd; color:white;
    padding:10px 14px; display:flex;
    justify-content:space-between;
    align-items:center; font-weight:bold;
  ">
    <span>H·ªó tr·ª£ ƒë·∫∑t v√©</span>
    <button id="chatClose"
      style="border:none;background:transparent;color:white;font-size:18px;font-weight:bold;cursor:pointer;">
      √ó
    </button>
  </div>

  <div id="chatMessages" style="
    flex:1; padding:8px; overflow-y:auto;
    background:#f7f7f7;
  "></div>

  <div id="chatInputWrap" style="display:flex;border-top:1px solid #ccc;">
    <input id="chatInput"
      style="flex:1;border:none;padding:10px;"
      placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button id="chatSend"
      style="background:#0d6efd;color:white;border:none;padding:10px 14px;">
      G·ª≠i
    </button>
  </div>
</div>
`;
        document.body.appendChild(wrapper);

        const chatBox = document.getElementById('chatBox');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatClose = document.getElementById('chatClose');
        const chatOpenBtn = document.getElementById('chatOpenBtn');

        // ===== ƒê√ìNG CHATBOX (√ó) -> hi·ªán n√∫t üí¨ =====
        chatClose.onclick = () => {
            chatBox.style.display = 'none';
            chatOpenBtn.style.display = 'flex';
        };

        // ===== M·ªû L·∫†I CHATBOX T·ª™ N√öT üí¨ =====
        chatOpenBtn.onclick = (e) => {
            // N·∫øu v·ª´a k√©o th√¨ kh√¥ng m·ªü chat khi th·∫£ chu·ªôt
            if (chatOpenBtn.__dragging) return;

            chatBox.style.display = 'flex';
            chatOpenBtn.style.display = 'none';
        };

        // ===== K√âO TH·∫¢ N√öT üí¨ + SNAP 12 V·ªä TR√ç =====
        (function makeDraggable(btn) {
            let isDown = false;
            let offsetX = 0;
            let offsetY = 0;

            // T·∫°o 12 v·ªã tr√≠ snap (theo k√≠ch th∆∞·ªõc m√†n h√¨nh hi·ªán t·∫°i)
            function getSnapPositions() {
                const margin = 10;
                const w = btn.offsetWidth;
                const h = btn.offsetHeight;

                const maxX = window.innerWidth - w - margin;
                const maxY = window.innerHeight - h - margin;

                const midX = (window.innerWidth - w) / 2;
                const midY = (window.innerHeight - h) / 2;

                const quarterX = (window.innerWidth - w) / 4;
                const threeQX = 3 * (window.innerWidth - w) / 4;

                return [
                    // 6 v·ªã tr√≠ c·∫°nh tr√°i / ph·∫£i (tr√™n ‚Äì gi·ªØa ‚Äì d∆∞·ªõi)
                    { left: margin, top: margin },
                    { left: margin, top: midY },
                    { left: margin, top: maxY },

                    { left: maxX, top: margin },
                    { left: maxX, top: midY },
                    { left: maxX, top: maxY },

                    // 6 v·ªã tr√≠ c·∫°nh tr√™n / d∆∞·ªõi (4 ƒëi·ªÉm chia ƒë·ªÅu + 2 gi·ªØa)
                    { left: quarterX, top: margin },
                    { left: midX, top: margin },
                    { left: threeQX, top: margin },

                    { left: quarterX, top: maxY },
                    { left: midX, top: maxY },
                    { left: threeQX, top: maxY },
                ];
            }

            function snapToNearest() {
                const rect = btn.getBoundingClientRect();
                const w = btn.offsetWidth;
                const h = btn.offsetHeight;

                const centerX = rect.left + w / 2;
                const centerY = rect.top + h / 2;

                const positions = getSnapPositions();
                let best = positions[0];
                let minDist = Infinity;

                for (let i = 0; i < positions.length; i++) {
                    const p = positions[i];
                    const cx = p.left + w / 2;
                    const cy = p.top + h / 2;
                    const d = (cx - centerX) * (cx - centerX) + (cy - centerY) * (cy - centerY);
                    if (d < minDist) {
                        minDist = d;
                        best = p;
                    }
                }

                btn.style.left = best.left + 'px';
                btn.style.top = best.top + 'px';
            }

            function startDrag(clientX, clientY) {
                isDown = true;
                btn.__dragging = true;

                // chuy·ªÉn t·ª´ right/bottom sang left/top n·∫øu ch∆∞a c√≥
                if (!btn.style.left && !btn.style.top) {
                    const rect = btn.getBoundingClientRect();
                    btn.style.left = rect.left + 'px';
                    btn.style.top = rect.top + 'px';
                    btn.style.right = 'auto';
                    btn.style.bottom = 'auto';
                }

                offsetX = clientX - btn.offsetLeft;
                offsetY = clientY - btn.offsetTop;
            }

            function doDrag(clientX, clientY) {
                if (!isDown) return;

                let x = clientX - offsetX;
                let y = clientY - offsetY;

                const margin = 4;
                const maxX = window.innerWidth - btn.offsetWidth - margin;
                const maxY = window.innerHeight - btn.offsetHeight - margin;

                if (x < margin) x = margin;
                if (y < margin) y = margin;
                if (x > maxX) x = maxX;
                if (y > maxY) y = maxY;

                btn.style.left = x + 'px';
                btn.style.top = y + 'px';
            }

            function endDrag() {
                if (!isDown) return;
                isDown = false;
                snapToNearest(); // <- h√∫t v·ªÅ v·ªã tr√≠ g·∫ßn nh·∫•t

                // Sau 150ms cho ph√©p click l·∫°i b√¨nh th∆∞·ªùng
                setTimeout(() => {
                    btn.__dragging = false;
                }, 150);
            }

            // Chu·ªôt
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e.clientX, e.clientY);
            });
            document.addEventListener('mousemove', (e) => {
                doDrag(e.clientX, e.clientY);
            });
            document.addEventListener('mouseup', () => {
                endDrag();
            });

            // C·∫£m ·ª©ng
            btn.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                startDrag(t.clientX, t.clientY);
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const t = e.touches[0];
                doDrag(t.clientX, t.clientY);
            }, { passive: false });

            document.addEventListener('touchend', () => {
                endDrag();
            });
        })(chatOpenBtn);


        // ===== HI·ªÇN TH·ªä MESSAGE TRONG KHUNG CHAT =====
        function addMsg(text, mine = false) {
            const div = document.createElement('div');
            div.style.margin = '6px 0';
            div.style.textAlign = mine ? 'right' : 'left';
            div.innerHTML = `
<span style="
  display:inline-block; padding:8px 12px;
  border-radius:12px; max-width:75%;
  white-space:pre-line;
  background:${mine ? '#0d6efd' : '#e9e9e9'};
  color:${mine ? 'white' : 'black'};
">${text}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ===== G·ª¨I TIN NH·∫ÆN L√äN BACKEND =====
        async function sendChat() {
            const text = chatInput.value.trim();
            if (!text) return;

            addMsg(text, true);
            chatInput.value = '';

            try {
                const res = await fetch(CHAT_API_BASE + '/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    addMsg('‚ö†Ô∏è L·ªói server, vui l√≤ng th·ª≠ l·∫°i sau.');
                    return;
                }
                addMsg(data.reply || '(Bot kh√¥ng tr·∫£ l·ªùi)');
            } catch (err) {
                console.error('Chat error:', err);
                addMsg('‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c m√°y ch·ªß.');
            }
        }

        chatSend.onclick = sendChat;
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        // L·ªùi ch√†o m·∫∑c ƒë·ªãnh
        addMsg('ü§ñ Bot: Xin ch√†o! B·∫°n c√≥ th·ªÉ h·ªèi: "Gi√° v√© Lagi ƒëi ƒê√† L·∫°t ng√†y mai?", "Gi·ªù ch·∫°y Lagi ‚Äì HCM h√¥m nay?" ...');
    })();
</script>



</body>
</html>
