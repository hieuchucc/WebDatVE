<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nh·∫≠p th√¥ng tin & Thanh to√°n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* =========================
        Checkout ‚Äî Du L·ªãch Ba Duy
        B·∫£n l√†m l·∫°i, hi·ªán ƒë·∫°i, tho√°ng
    ========================== */

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
      --primary: #0A5AD7;
      --primary-600: #0C63E7;
      --primary-700: #0847A5;
      --primary-soft: rgba(10, 90, 215, 0.08);
      --accent: #FFD03B;
      --accent-soft: rgba(255, 208, 59, 0.12);
      --bg: #F3F5FB;
      --card: #FFFFFF;
      --text: #0F172A;
      --text-soft: #4B5563;
      --muted: #94A3B8;
      --border: #E2E8F0;
      --danger: #EF4444;
      --success: #16A34A;
      --radius-lg: 18px;
      --shadow: 0 10px 40px rgba(15, 23, 42, .08);
      --focus-ring: 0 0 0 3px rgba(10, 90, 215, .25);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(10, 90, 215, .09), transparent 50%),
        radial-gradient(900px 500px at 110% 20%, rgba(255, 208, 59, .05), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== Header ===== */

    .fw-header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: saturate(180%) blur(18px);
      background: linear-gradient(120deg,
          rgba(10, 90, 215, .98) 0%,
          rgba(7, 73, 167, .98) 42%,
          rgba(13, 65, 131, .95) 100%);
      box-shadow: 0 10px 38px rgba(15, 23, 42, 0.08);
    }

    .fw-header__inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: .75rem;
      text-decoration: none;
    }

    .brand__logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: #fff;
      object-fit: cover;
      box-shadow: 0 4px 14px rgba(0, 0, 0, .1);
    }

    .brand__title {
      color: #fff;
      font-weight: 800;
      letter-spacing: -.015em;
      font-size: 1.1rem;
    }

    .hotline-btn {
      background: #fff !important;
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 999px;
      font-weight: 600;
      display: flex;
      gap: .5rem;
      align-items: center;
      box-shadow: 0 10px 28px rgba(0, 0, 0, .08);
      color: var(--text);
    }

    .hotline-menu {
      min-width: 280px;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    /* ===== Page layout ===== */

    .page {
      max-width: 1200px;
      margin: 14px auto 60px;
      padding: 0 1rem;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 330px;
      gap: 1.5rem;
      align-items: flex-start;
    }

    /* ===== Intro ===== */

    .checkout-intro {
      grid-column: 1 / -1;
      margin-top: .6rem;
    }

    .intro-header-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }

    .intro-row {
      display: flex;
      align-items: center;
      gap: .6rem;
      flex-wrap: wrap;
      margin-bottom: .25rem;
    }

    .intro-back {
      background: rgba(255, 255, 255, .25);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(10, 90, 215, .25);
      padding: .35rem .8rem;
      border-radius: 999px;
      display: inline-flex;
      gap: .4rem;
      align-items: center;
      text-decoration: none;
      color: var(--primary);
      font-weight: 600;
      transition: .15s;
    }

    .intro-back:hover {
      background: #fff;
    }

    .intro-title {
      font-weight: 800;
      font-size: clamp(1.55rem, 2.4vw, 1.9rem);
      letter-spacing: -.015em;
      margin-bottom: .1rem;
    }

    .intro-sub {
      color: var(--muted);
      margin-bottom: .35rem;
    }

    /* ===== 5-step bar ===== */

    .checkout-steps {
      display: flex;
      gap: .4rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: .4rem;
      white-space: nowrap;
    }

    .step-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 2px solid rgba(15, 23, 42, .08);
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
      font-weight: 700;
      color: var(--muted);
    }

    .step-label {
      font-size: .75rem;
      color: var(--muted);
      font-weight: 500;
    }

    .step-line {
      width: 36px;
      height: 2px;
      background: rgba(148, 163, 184, .35);
    }

    .step-item.is-active .step-badge {
      background: var(--primary);
      border-color: rgba(10, 90, 215, .1);
      color: #fff;
      box-shadow: 0 4px 12px rgba(10, 90, 215, .4);
    }

    .step-item.is-active .step-label {
      color: var(--text);
      font-weight: 600;
    }

    .step-item.is-done .step-badge {
      background: rgba(22, 163, 74, .15);
      border-color: rgba(22, 163, 74, .12);
      color: #166534;
    }

    .step-item.is-done .step-label {
      color: #166534;
      font-weight: 500;
    }

    /* ===== expired banner ===== */

    .hold-expired-banner {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.2);
      border-left: 4px solid #ef4444;
      color: #991b1b;
      border-radius: .9rem;
      padding: .55rem .75rem;
      font-size: .78rem;
      display: none;
      gap: .4rem;
      align-items: center;
      margin-top: .45rem;
    }

    .hold-expired-banner.show {
      display: flex;
    }

    /* ===== Cards ===== */

    .card-clean {
      background: var(--card);
      border: 1px solid rgba(226, 232, 240, .7);
      border-radius: 1.1rem;
      box-shadow: 0 20px 40px rgba(148, 163, 184, .08);
      transition: .15s;
    }

    .card-clean:hover {
      border-color: rgba(10, 90, 215, .25);
    }

    .card-body {
      padding: 1.25rem 1.25rem 1.25rem;
    }

    /* ===== Hold summary (main top card) ===== */

    .hold-title-line {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: flex-start;
    }

    .badge-hold {
      background: linear-gradient(180deg, #0A5AD7 0%, #0847A5 100%);
      border: 1px solid rgba(255, 255, 255, .2);
      border-radius: 999px;
      color: #fff;
      font-weight: 700;
      padding: .35rem .6rem;
      font-size: .7rem;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    .hold-txt {
      font-size: .78rem;
      color: var(--muted);
    }

    .countdown {
      background: #FFF4E5;
      border: 1px dashed rgba(245, 158, 11, .48);
      color: #8B5E00;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      border-radius: 12px;
      padding: .2rem .65rem;
      font-size: 1.1rem;
      line-height: 1.3;
      min-width: 76px;
      text-align: center;
    }

    .line-muted {
      border-top: 1px dashed rgba(226, 232, 240, .85);
      margin: 14px 0 15px;
    }

    .label-sm {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: var(--muted);
      margin-bottom: 3px;
      font-weight: 600;
    }

    .seat-chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      background: rgba(10, 90, 215, .06);
      border: 1px solid rgba(10, 90, 215, .15);
      color: var(--text);
      border-radius: 999px;
      padding: .25rem .6rem;
      font-weight: 600;
      margin-right: .25rem;
      margin-bottom: .25rem;
    }

    /* ===== Right column summary ===== */

    .summary-panel {
      position: sticky;
      top: 68px;
    }

    .summary-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .5rem;
    }

    .summary-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .price-total {
      font-size: 1.6rem;
      font-weight: 800;
      color: #B91C1C;
    }

    .badge-soft {
      background: rgba(10, 90, 215, .08);
      border: 1px solid rgba(10, 90, 215, .05);
      border-radius: 99px;
      padding: .3rem .65rem;
      font-weight: 500;
      color: var(--text-soft);
      font-size: .74rem;
    }

    /* ===== Form ===== */

    .section-title {
      font-weight: 700;
      font-size: 1.02rem;
      margin-bottom: .6rem;
      display: flex;
      align-items: center;
      gap: .4rem;
    }

    .section-title small {
      color: var(--muted);
      font-weight: 500;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: .35rem;
    }

    .form-control,
    .form-select {
      border-radius: .8rem;
      border: 1px solid rgba(226, 232, 240, .9);
      height: 46px;
      background: rgba(255, 255, 255, .8);
      transition: .1s;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: rgba(10, 90, 215, .5);
      box-shadow: var(--focus-ring);
      background: #fff;
    }

    .form-check-input {
      width: 1.05rem;
      height: 1.05rem;
      border-radius: .4rem;
      border: 1px solid #CBD5E1;
    }

    .form-check-input:checked {
      background: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary {
      background: linear-gradient(180deg, #0A5AD7 0%, #0847A5 100%);
      border: none;
      border-radius: 999px;
      font-weight: 700;
      padding: .65rem 1.4rem;
      box-shadow: 0 12px 26px rgba(10, 90, 215, .3);
    }

    .btn-outline-danger {
      border-radius: 999px;
      font-weight: 600;
    }

    .small-muted {
      font-size: .78rem;
      color: var(--muted);
    }

    /* ===== Result card ===== */

    #cardResult .badge {
      border-radius: .6rem;
    }

    /* ===== Responsive ===== */

    @media (max-width: 991px) {
      .page {
        grid-template-columns: 1fr;
      }

      .summary-panel {
        position: static;
      }

      .intro-header-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .checkout-steps {
        order: 2;
      }
    }

    @media (max-width: 576px) {
      .fw-header__inner {
        gap: .5rem;
      }

      .brand__title {
        display: none;
      }

      .card-body {
        padding: 1rem .95rem 1rem;
      }

      .checkout-steps {
        gap: .25rem;
      }

      .step-label {
        display: none;
      }

      .intro-title {
        font-size: 1.4rem;
      }
    }
  </style>
</head>

<body>
  <header class="fw-header">
    <div class="fw-header__inner">
      <a href="index.html" class="brand">
        <img
          src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSdk1KSWlpLDRMeHJM6uZpOhHTWgzEzgDuU6ZKf1go82QKatnJwwUWcGVz3nC1JHMUHa34&usqp=CAU"
          class="brand__logo">
        <span class="brand__title">Du L·ªãch Ba Duy</span>
      </a>

      <div class="dropdown">
        <button class="btn btn-light hotline-btn" id="hotlineDropdown" data-bs-toggle="dropdown">
          <img src="https://cdn-icons-png.freepik.com/512/3488/3488550.png" width="28" height="28"
            class="rounded-circle bg-white p-1 shadow-sm hotline-icon">
          Hotline 24/7
        </button>

        <ul class="dropdown-menu p-3 dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="tel:0123456789">
              <div class="fw-bold">0123456789</div>
              <small class="text-muted">Ph·∫£n h·ªìi d·ªãch v·ª• & s·ª± c·ªë</small>
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="tel:0987654321">
              <div class="fw-bold">0987654321</div>
              <small class="text-muted">ƒê·∫∑t v√© qua ƒëi·ªán tho·∫°i</small>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <!-- ========================= INTRO ========================= -->
  <section class="checkout-intro py-3">
    <div class="container">

      <div class="intro-header-row d-flex justify-content-between align-items-center flex-wrap">
        <a href="index.html" class="intro-back">‚Üê Trang ch·ªß</a>

        <div class="checkout-steps" id="checkoutSteps">
          <div class="step-item is-done">
            <span class="step-badge">1</span>
            <span class="step-label">Ch·ªçn chuy·∫øn</span>
            <span class="step-line"></span>
          </div>

          <div class="step-item is-done">
            <span class="step-badge">2</span>
            <span class="step-label">Ch·ªçn gh·∫ø</span>
            <span class="step-line"></span>
          </div>

          <div class="step-item is-active" data-step="3">
            <span class="step-badge">3</span>
            <span class="step-label">Th√¥ng tin</span>
            <span class="step-line"></span>
          </div>

          <div class="step-item" data-step="4">
            <span class="step-badge">4</span>
            <span class="step-label">Thanh to√°n</span>
            <span class="step-line"></span>
          </div>

          <div class="step-item" data-step="5">
            <span class="step-badge">5</span>
            <span class="step-label">Ho√†n t·∫•t</span>
          </div>
        </div>
      </div>

      <h1 class="intro-title mt-3 text-center">
        X√°c nh·∫≠n th√¥ng tin gi·ªØ ch·ªó & Thanh to√°n
      </h1>

      <div id="holdExpiredMsg" class="hold-expired-banner">
        <strong>‚è∞ H·∫øt th·ªùi gian gi·ªØ ch·ªó.</strong>
        <span>Vui l√≤ng quay l·∫°i ƒë·ªÉ ch·ªçn gh·∫ø.</span>
        <a href="index.html" class="ms-auto text-decoration-underline small">Quay l·∫°i</a>
      </div>

    </div>
  </section>

  <main class="page">

    <!-- LEFT COLUMN -->
    <div class="left-col d-flex flex-column gap-3">

      <!-- ========================= TH√îNG TIN GI·ªÆ CH·ªñ ========================= -->
      <div class="card-clean" id="cardHold">
        <div class="card-body">

          <div class="hold-title-line d-flex justify-content-between align-items-start">
            <div>
              <div class="d-flex gap-2 align-items-center mb-1">
                <span class="badge-hold">Gi·ªØ ch·ªó</span>
                <span id="holdId" class="text-muted small mono"></span>
              </div>
              <div id="routeText" class="fw-bold fs-5 mb-1"></div>
              <div id="departText" class="hold-txt"></div>
            </div>

            <div class="text-end">
              <div class="small text-muted mb-1">C√≤n l·∫°i</div>
              <div class="countdown fs-4 fw-bold text-danger" id="leftTime">--:--</div>
            </div>
          </div>

          <hr class="line-muted">

          <div class="row g-3">
            <div class="col-md-4 col-sm-6">
              <div class="label-sm">Gh·∫ø</div>
              <div id="seatList"></div>
            </div>

            <div class="col-md-4 col-sm-6">
              <div class="label-sm">ƒê∆°n gi√°</div>
              <div id="priceEach" class="fw-semibold text-secondary"></div>
            </div>

            <div class="col-md-4 text-md-end">
              <div class="label-sm">T·ªïng ti·ªÅn</div>
              <div id="totalAmount" class="fw-bold fs-5 text-danger"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- ========================= FORM KH√ÅCH H√ÄNG ========================= -->
      <div class="card-clean">
        <div class="card-body">
          <div class="section-title">
            Th√¥ng tin kh√°ch h√†ng
            <small>(Th√¥ng tin n√†y s·∫Ω hi·ªÉn th·ªã tr√™n v√©)</small>
          </div>

          <form id="customerForm" class="row g-3 mt-1" novalidate>

            <div class="col-md-6">
              <label class="form-label">H·ªç v√† t√™n</label>
              <input id="name" class="form-control" required placeholder="Nguy·ªÖn VƒÉn A">
              <div class="invalid-feedback">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
              <input id="phone" class="form-control" required pattern="^[0-9]{9,11}$" placeholder="09x...">
              <div class="invalid-feedback">S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Email (tu·ª≥ ch·ªçn)</label>
              <input id="email" type="email" class="form-control" placeholder="you@email.com">
            </div>

            <div class="col-md-6">
              <label class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn)</label>
              <input id="note" class="form-control"
                placeholder="V√≠ d·ª•: C√≥ tr·∫ª em, h√†nh l√Ω c·ªìng k·ªÅnh...">
            </div>

            <div class="col-md-6">
              <label class="form-label">ƒêi·ªÉm ƒë√≥n</label>
              <input id="pickupPoint" class="form-control" list="pickupList" required
                placeholder="Ch·ªçn ƒëi·ªÉm ƒë√≥n">
              <datalist id="pickupList"></datalist>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë√≥n.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">ƒêi·ªÉm tr·∫£</label>
              <input id="dropoffPoint" class="form-control" list="dropoffList" required
                placeholder="Ch·ªçn ƒëi·ªÉm tr·∫£">
              <datalist id="dropoffList"></datalist>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn ƒëi·ªÉm tr·∫£.</div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5 class="mb-0">Xe trung chuy·ªÉn (ƒë∆∞a r∆∞·ªõc t·∫≠n n∆°i)</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label fw-semibold">Nhu c·∫ßu trung chuy·ªÉn</label>
                  <select id="transferOption" class="form-select">
                    <option value="none">Kh√¥ng c·∫ßn trung chuy·ªÉn</option>
                    <option value="pickup">ƒê√≥n t·∫≠n n∆°i</option>
                    <option value="dropoff">Tr·∫£ t·∫≠n n∆°i</option>
                    <option value="both">ƒê√≥n & tr·∫£ t·∫≠n n∆°i</option>
                  </select>
                  <div class="form-text">
                    D·ªãch v·ª• c√≥ th·ªÉ thu th√™m ph·ª• ph√≠ t√πy khu v·ª±c. Nh√¢n vi√™n s·∫Ω li√™n h·ªá x√°c nh·∫≠n.
                  </div>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">
                      ƒê·ªãa ch·ªâ ƒë√≥n t·∫≠n n∆°i
                    </label>
                    <div class="input-group">
                      <input id="pickupAddress" class="form-control"
                        placeholder="V√≠ d·ª•: 12 Nguy·ªÖn Hu·ªá, Lagi..." />
                      <button class="btn btn-outline-primary" type="button" id="btnUseCurrentLocation">
                        L·∫•y v·ªã tr√≠ c·ªßa t√¥i
                      </button>
                    </div>
                    <div class="form-text">
                      B·∫•m ‚ÄúL·∫•y v·ªã tr√≠ c·ªßa t√¥i‚Äù ƒë·ªÉ h·ªá th·ªëng d√πng ƒë·ªãnh v·ªã GPS (tr√™n ƒëi·ªán tho·∫°i b·∫≠t cho tr√¨nh duy·ªát).
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-semibold">
                      ƒê·ªãa ch·ªâ tr·∫£ kh√°ch (n·∫øu c√≥)
                    </label>
                    <input id="dropoffAddress" class="form-control"
                      placeholder="V√≠ d·ª•: 45 L√™ L·ª£i, Q.1, TP.HCM..." />
                  </div>
                </div>

                <div class="mt-3">
                  <label class="form-label fw-semibold">Ghi ch√∫ gi·ªù gi·∫•c trung chuy·ªÉn</label>
                  <textarea id="transferTimeNote" class="form-control" rows="2"
                    placeholder="V√≠ d·ª•: ƒê√≥n tr∆∞·ªõc gi·ªù xe ch·∫°y 30 ph√∫t, c√≥ ng∆∞·ªùi l·ªõn tu·ªïi c·∫ßn h·ªó tr·ª£..."></textarea>
                </div>

                <!-- Xem nhanh v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì -->
                <div class="mt-3" id="mapWrapper" style="display:none;">
                  <label class="form-label fw-semibold">B·∫£n ƒë·ªì v·ªã tr√≠ ƒë√≥n (tham kh·∫£o)</label>
                  <div class="ratio ratio-16x9">
                    <iframe id="mapPreview" style="border:0;" loading="lazy"
                      referrerpolicy="no-referrer-when-downgrade"></iframe>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
              <select id="paymentMethod" class="form-select" required>
                <option value="">Ch·ªçn ph∆∞∆°ng th·ª©c</option>
                <option value="cod">Thanh to√°n khi l√™n xe / t·∫°i vƒÉn ph√≤ng</option>
                <option value="vnpay">VNPay</option>
                <option value="momo">V√≠ MoMo</option>
              </select>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.</div>
            </div>

            <div class="col-12 form-check ms-1">
              <input class="form-check-input" type="checkbox" id="agree" required>
              <label class="form-check-label" for="agree">
                T√¥i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n & ch√≠nh s√°ch ho√†n hu·ª∑.
              </label>
              <div class="invalid-feedback">B·∫°n c·∫ßn ƒë·ªìng √Ω ƒëi·ªÅu kho·∫£n tr∆∞·ªõc khi ti·∫øp t·ª•c.</div>
            </div>

            <div class="col-12 d-flex gap-2 flex-wrap">
              <button id="btnConfirm" class="btn btn-primary" type="submit">
                X√°c nh·∫≠n ƒë·∫∑t v√©
              </button>

              <button id="btnCancel" class="btn btn-outline-danger" type="button">
                Hu·ª∑ gi·ªØ ch·ªó
              </button>
            </div>

            <div id="formMsg" class="small-muted mt-1" aria-live="polite"></div>

          </form>
        </div>
      </div>

      <!-- ========================= K·∫æT QU·∫¢ ========================= -->
      <div class="card-clean d-none" id="cardResult">
        <div class="card-body">
          <h2 class="section-title mb-2">K·∫øt qu·∫£ ƒë·∫∑t v√©</h2>
          <div id="resultText" class="mt-2"></div>
          <a href="index.html" class="btn btn-link ps-0 mt-3">
            ‚Üê V·ªÅ Trang ch·ªß
          </a>
        </div>
      </div>

    </div>

    <!-- ========================= RIGHT SUMMARY ========================= -->
    <aside class="summary-panel">
      <div class="card-clean mb-3">
        <div class="card-body">

          <div class="summary-head d-flex justify-content-between align-items-start">
            <div>
              <div class="summary-title">T√≥m t·∫Øt ƒë∆°n</div>
              <div class="small-muted">B·∫°n ƒëang gi·ªØ ch·ªó t·∫°m th·ªùi</div>
            </div>
            <span class="badge-soft" id="summaryRoute">--</span>
          </div>

          <div class="d-flex justify-content-between mt-3 mb-2">
            <span class="text-secondary">Tuy·∫øn</span>
            <span id="summaryDepart" class="fw-semibold">--</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-secondary">Gh·∫ø</span>
            <span id="summarySeats" class="fw-semibold">--</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-secondary">ƒê∆°n gi√°</span>
            <span id="summaryPriceEach" class="fw-semibold">--</span>
          </div>

          <hr class="line-muted">

          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold text-secondary">T·ªïng thanh to√°n</span>
            <span class="price-total" id="summaryTotal">--</span>
          </div>

        </div>
      </div>

      <div class="card-clean">
        <div class="card-body">
          <div class="fw-semibold mb-1">L∆∞u √Ω</div>
          <ul class="small-muted ps-3 mb-0">
            <li>V√© ch·ªâ gi·ªØ trong th·ªùi gian ƒë·∫øm ng∆∞·ª£c.</li>
            <li>N·∫øu h·∫øt th·ªùi gian, vui l√≤ng quay l·∫°i ch·ªçn gh·∫ø.</li>
            <li>Thanh to√°n VNPay s·∫Ω t·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng.</li>
          </ul>
        </div>
      </div>

    </aside>

  </main>

  <!-- ========================= LOGIN MODAL ========================= -->
  <div class="modal fade modal-login" id="modalLoginRequired" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p</h5>
        </div>

        <div class="modal-body">
          <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin, theo d√µi v√© ƒë√£ ƒë·∫∑t v√† h∆∞·ªüng nhi·ªÅu ti·ªán √≠ch.</p>
          <a href="login.html" class="btn btn-primary w-100">ƒêƒÉng nh·∫≠p ngay</a>
          <div class="text-center small mt-2">
            Ho·∫∑c <a href="register.html">ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi</a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ===========================================================
       C·∫§U H√åNH API + ROUTE + ƒêI·ªÇM ƒê√ìN/TR·∫¢
    =========================================================== */
    const API_BASE = 'https://webdatve.onrender.com/api';

    const ROUTE_LABEL = {
      'LAGI-HCM': 'Lagi - TP. H·ªì Ch√≠ Minh',
      'HCM-LAGI': 'TP. H·ªì Ch√≠ Minh - Lagi',
      'LAGI-DALAT': 'Lagi - ƒê√† L·∫°t',
      'DALAT-LAGI': 'ƒê√† L·∫°t - Lagi',
      'LAGI-NTRANG': 'Lagi - Nha Trang',
      'NTRANG-LAGI': 'Nha Trang - Lagi'
    };

    const PICKUP_POINTS = {
      'LAGI-HCM': ['B·∫øn xe Lagi', 'V√≤ng xoay Lagi', 'QL55 - Ng√£ 3 T√¢n H·∫£i'],
      'LAGI-DALAT': ['B·∫øn xe Lagi', 'C·ªïng ch·ª£ Lagi', 'QL55 - Ng√£ 3 H√≤a Minh'],
      'LAGI-NTRANG': ['B·∫øn xe Lagi', 'C·∫ßu ƒêa Tro', 'QL1A - Ng√£ 3 T√¢n Nghƒ©a']
    };

    const DROPOFF_POINTS = {
      'LAGI-HCM': ['BX Mi·ªÅn ƒê√¥ng M·ªõi', 'Th·ªß ƒê·ª©c - Xa L·ªô H√† N·ªôi', 'Q1 - B·∫øn Th√†nh'],
      'LAGI-DALAT': ['BX Li√™n T·ªânh ƒê√† L·∫°t', 'Ch·ª£ ƒê√† L·∫°t', 'B√πi Th·ªã Xu√¢n'],
      'LAGI-NTRANG': ['BX Ph√≠a Nam Nha Trang', 'Th√°p B√†', 'Tr·∫ßn Ph√∫ - Trung t√¢m']
    };

    // T·ª± mirror chi·ªÅu ng∆∞·ª£c l·∫°i
    (function mirror() {
      const pairs = [
        ['LAGI-HCM', 'HCM-LAGI'],
        ['LAGI-DALAT', 'DALAT-LAGI'],
        ['LAGI-NTRANG', 'NTRANG-LAGI']
      ];
      pairs.forEach(([go, back]) => {
        if (!PICKUP_POINTS[back]) PICKUP_POINTS[back] = DROPOFF_POINTS[go];
        if (!DROPOFF_POINTS[back]) DROPOFF_POINTS[back] = PICKUP_POINTS[go];
      });
    })();

    /* ===========================================================
       TI·ªÜN √çCH CHUNG
    =========================================================== */
    const byId = id => document.getElementById(id);
    const fmtVND = n => new Intl.NumberFormat('vi-VN').format(n) + 'ƒë';

    function getQuery(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function renderOptions(list, datalistEl) {
      datalistEl.innerHTML = '';
      (list || []).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        datalistEl.appendChild(opt);
      });
    }

    function setStepActive(stepNumber) {
      const items = document.querySelectorAll('#checkoutSteps .step-item');
      items.forEach((el, idx) => {
        el.classList.remove('is-active', 'is-done');
        const s = idx + 1;
        if (s < stepNumber) el.classList.add('is-done');
        if (s === stepNumber) el.classList.add('is-active');
      });
    }

    /* ===========================================================
       KI·ªÇM TRA ƒêƒÇNG NH·∫¨P + T·ª∞ ƒêI·ªÄN USER
    =========================================================== */
    let currentUser = null;

    function loadUserInfo() {
      try {
        const data = localStorage.getItem("user");
        if (!data) {
          currentUser = null;
          lockFormForGuest();
          return;
        }

        currentUser = JSON.parse(data);

        // ‚¨Ö T·ª∞ ƒêI·ªÄN 
        if (currentUser.displayName) byId("name").value = currentUser.displayName;
        if (currentUser.phone) byId("phone").value = currentUser.phone;
        if (currentUser.email) byId("email").value = currentUser.email;

        // ‚¨Ö KHO√Å L·∫†I
        byId("phone").readOnly = true;
        byId("email").readOnly = true;

      } catch {
        currentUser = null;
        lockFormForGuest();
      }
    }

    function lockFormForGuest() {
      byId('phone').readOnly = true;
      byId('email').readOnly = true;

      // üî• L∆ØU L·∫†I URL HI·ªÜN T·∫†I ƒê·ªÇ LOGIN XONG TR·ªû V·ªÄ
      localStorage.setItem("redirectBack", window.location.href);

      const modal = new bootstrap.Modal(byId('modalLoginRequired'));
      modal.show();
    }

    /* ===========================================================
       B·∫¢O V·ªÜ URL ‚Üí KH√îNG C√ì HOLD => V·ªÄ TRANG CH·ª¶
    =========================================================== */
    if (!getQuery('hold')) {
      window.location.href = 'index.html';
    }

    /* ===========================================================
       T·∫¢I HOLD T·ª™ BACKEND
    =========================================================== */
    let holdCtx = null;
    let timer = null;

    async function loadHold() {
      const holdId = getQuery('hold');
      byId('holdId').textContent = holdId;

      try {
        const res = await fetch(`${API_BASE}/holds/${holdId}`);
        const data = await res.json();

        if (!res.ok || data.ok === false) {
          showResult(data.message || 'Kh√¥ng t√¨m th·∫•y gi·ªØ ch·ªó.');
          return;
        }

        // Chu·∫©n ho√° d·ªØ li·ªáu
        holdCtx = {
          holdId: data.holdId || data._id,
          routeCode: data.routeCode,
          date: data.date,
          departHM: data.departHM,
          seatCodes: data.seatCodes || [],
          priceEach: data.priceEach || 0,
          expiresAt: data.expiresAt
        };

        // Render UI
        const routeText = ROUTE_LABEL[holdCtx.routeCode] || holdCtx.routeCode;
        byId('routeText').textContent = routeText;
        byId('departText').textContent = `${holdCtx.date} ‚Ä¢ ${holdCtx.departHM}`;

        byId('seatList').innerHTML = holdCtx.seatCodes
          .map(s => `<span class="seat-chip">${s}</span>`).join('');

        const total = holdCtx.seatCodes.length * holdCtx.priceEach;
        byId('priceEach').textContent = fmtVND(holdCtx.priceEach);
        byId('totalAmount').textContent = fmtVND(total);
        byId('totalAmount').dataset.amount = total;

        // Right summary
        byId('summaryRoute').textContent = routeText;
        byId('summaryDepart').textContent = `${holdCtx.date} ‚Ä¢ ${holdCtx.departHM}`;
        byId('summarySeats').textContent = holdCtx.seatCodes.join(', ');
        byId('summaryPriceEach').textContent = fmtVND(holdCtx.priceEach);
        byId('summaryTotal').textContent = fmtVND(total);

        // ƒêi·ªÉm ƒë√≥n/tr·∫£
        renderOptions(PICKUP_POINTS[holdCtx.routeCode], byId('pickupList'));
        renderOptions(DROPOFF_POINTS[holdCtx.routeCode], byId('dropoffList'));

        // Countdown
        startCountdown(holdCtx.expiresAt);

      } catch (err) {
        console.error(err);
        showResult('Kh√¥ng th·ªÉ t·∫£i gi·ªØ ch·ªó.');
      }
    }

    /* ===========================================================
       COUNTDOWN
    =========================================================== */
    function startCountdown(expiresAt) {
      clearInterval(timer);
      const end = new Date(expiresAt).getTime();
      const el = byId('leftTime');

      function tick() {
        const left = Math.max(0, end - Date.now());
        const mm = String(Math.floor(left / 60000)).padStart(2, '0');
        const ss = String(Math.floor((left % 60000) / 1000)).padStart(2, '0');
        el.textContent = `${mm}:${ss}`;

        if (left <= 0) {
          clearInterval(timer);
          disableHoldExpired();
        }
      }

      tick();
      timer = setInterval(tick, 1000);
    }

    /* ===========================================================
       H·∫æT GI·ªÆ CH·ªñ ‚Üí KH√ìA FORM
    =========================================================== */
    function disableHoldExpired() {
      byId('btnConfirm').disabled = true;
      byId('btnCancel').disabled = true;

      byId('formMsg').textContent = 'Gi·ªØ ch·ªó ƒë√£ h·∫øt h·∫°n. Vui l√≤ng quay l·∫°i ch·ªçn gh·∫ø.';
      byId('formMsg').classList.add('text-danger');

      byId('holdExpiredMsg').classList.add('show');
    }

    function showResult(html) {
      byId('cardResult').classList.remove('d-none');
      byId('resultText').innerHTML = html;
      byId('customerForm').closest('.card-clean').classList.add('d-none');
      byId('cardHold').classList.add('d-none');

      setStepActive(5);
    }

    window.addEventListener("DOMContentLoaded", () => {
      console.log("Checkout loaded OK");
      loadUserInfo(); // ki·ªÉm tra ƒëƒÉng nh·∫≠p + auto-fill
      setStepActive(3); // b∆∞·ªõc hi·ªán t·∫°i
      loadHold(); // t·∫£i gi·ªØ ch·ªó
    });
  </script>

  <script>
    /* ===========================================================
       H√ÄM H·ªñ TR·ª¢ UX ‚Äì Loading n√∫t
    =========================================================== */
    function setLoading(isLoading, text = 'ƒêang x·ª≠ l√Ω...') {
      const btn = byId('btnConfirm');
      if (isLoading) {
        btn.disabled = true;
        btn.dataset.prev = btn.innerHTML;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${text}`;
      } else {
        btn.disabled = false;
        if (btn.dataset.prev) btn.innerHTML = btn.dataset.prev;
      }
    }
  </script>

  <script>
    /* ===========================================================
       THANH TO√ÅN V√ç ƒêI·ªÜN T·ª¨ DEMO (QR CODE)
       ‚Üí D√πng khi b·∫°n mu·ªën test m√¥ ph·ªèng v√≠ Momo / ZaloPay
    =========================================================== */
    let payTimer = null;
    let pollTimer = null;

    async function createWalletPayment(bookingId, method) {
      // ·∫®n form ‚Äì hi·ªán card k·∫øt qu·∫£
      byId('cardResult').classList.remove('d-none');
      byId('customerForm').closest('.card-clean').classList.add('d-none');
      byId('cardHold').classList.add('d-none');
      byId('resultText').innerHTML = `<p>T·∫°o y√™u c·∫ßu thanh to√°n...</p>`;

      try {
        const res = await fetch(`${API_BASE}/payments/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            bookingId,
            method
          })
        });

        const p = await res.json();
        if (!res.ok || p.ok === false) {
          byId('resultText').innerHTML =
            `<p class="text-danger">Kh√¥ng t·∫°o ƒë∆∞·ª£c thanh to√°n: ${p.message || ''}</p>`;
          setLoading(false);
          return;
        }

        // Hi·ªÉn th·ªã giao di·ªán thanh to√°n
        byId('resultText').innerHTML = `
      <div class="d-flex justify-content-between flex-wrap gap-3">
        <div>
          <div>Ph∆∞∆°ng th·ª©c: <strong>${method.toUpperCase()}</strong></div>
          <div>S·ªë ti·ªÅn: <strong>${fmtVND(p.amount)}</strong></div>
          <div>H·∫øt h·∫°n: <span id="payLeft" class="mono">--:--</span></div>

          <div class="mt-3 d-flex gap-2">
            <a class="btn btn-success" href="${p.payUrl}" target="_blank" rel="noopener">M·ªü link thanh to√°n</a>
            <button id="btnCopyLink" class="btn btn-outline-secondary">Sao ch√©p link</button>
          </div>
        </div>

        <div>
          <img src="${p.qrImageDataUrl}" alt="QR" 
               style="width:220px;height:220px;border:1px solid #ddd;border-radius:8px;">
        </div>
      </div>

      <div class="mt-2">Qu√©t QR ho·∫∑c nh·∫•n ‚ÄúM·ªü link thanh to√°n‚Äù.</div>
      <div class="mt-2">Tr·∫°ng th√°i: <span id="payStatus" class="badge bg-warning text-dark">ƒêang ch·ªù...</span></div>
    `;

        // Copy link
        document.getElementById('btnCopyLink').onclick = async () => {
          try {
            await navigator.clipboard.writeText(p.payUrl);
            alert('ƒê√£ sao ch√©p link!');
          } catch {
            alert('Kh√¥ng th·ªÉ sao ch√©p, copy th·ªß c√¥ng nh√©.');
          }
        };

        // Countdown + polling
        startPayCountdown(p.expiresAt);
        startPollingPayment(p.intentId);

        setLoading(false);

      } catch (err) {
        console.error(err);
        byId('resultText').innerHTML = `<p class="text-danger">L·ªói k·∫øt n·ªëi khi t·∫°o thanh to√°n.</p>`;
        setLoading(false);
      }
    }

    /* ===========================================================
       COUNTDOWN THANH TO√ÅN DEMO
    =========================================================== */
    function startPayCountdown(expiresAt) {
      clearInterval(payTimer);
      const end = new Date(expiresAt).getTime();
      const el = byId('payLeft');

      function tick() {
        const left = Math.max(0, end - Date.now());
        const mm = String(Math.floor(left / 60000)).padStart(2, '0');
        const ss = String(Math.floor((left % 60000) / 1000)).padStart(2, '0');
        el.textContent = `${mm}:${ss}`;

        if (left <= 0) {
          clearInterval(payTimer);
          const ps = byId('payStatus');
          ps.textContent = 'H·∫øt h·∫°n';
          ps.className = 'badge bg-secondary';
        }
      }

      tick();
      payTimer = setInterval(tick, 1000);
    }

    /* ===========================================================
       POLLING TR·∫†NG TH√ÅI THANH TO√ÅN DEMO
    =========================================================== */
    function startPollingPayment(intentId) {
      clearInterval(pollTimer);

      async function poll() {
        try {
          const res = await fetch(`${API_BASE}/payments/${intentId}/status`);
          const data = await res.json();

          if (!res.ok || data.ok === false) return;

          const ps = byId('payStatus');

          if (data.status === 'pending') return;

          if (data.status === 'paid') {
            ps.textContent = 'ƒê√£ thanh to√°n';
            ps.className = 'badge bg-success';
            clearInterval(pollTimer);

            // Chuy·ªÉn sang b∆∞·ªõc 5
            setStepActive(5);
          } else if (data.status === 'expired' || data.status === 'cancelled') {
            ps.textContent = data.status === 'expired' ? 'H·∫øt h·∫°n' : 'ƒê√£ hu·ª∑';
            ps.className = 'badge bg-secondary';
            clearInterval(pollTimer);
          }

        } catch { }
      }

      pollTimer = setInterval(poll, 3000);
    }

    /* ===========================================================
       HU·ª∂ GI·ªÆ CH·ªñ
    =========================================================== */
    byId('btnCancel').addEventListener('click', async () => {
      if (!holdCtx) return;

      if (!confirm('X√°c nh·∫≠n hu·ª∑ gi·ªØ ch·ªó?')) return;

      byId('btnCancel').disabled = true;

      try {
        await fetch(`${API_BASE}/holds/${holdCtx.holdId}`, {
          method: 'DELETE'
        });
      } catch { }

      showResult('<p>ƒê√£ hu·ª∑ gi·ªØ ch·ªó. B·∫°n c√≥ th·ªÉ quay l·∫°i ch·ªçn chuy·∫øn kh√°c.</p>');
    });

    /* ===========================================================
       KH·ªûI ƒê·ªòNG CU·ªêI C√ôNG (trung chuy·ªÉn + map)
    =========================================================== */
    (function () {
      const transferOptionSelect = document.getElementById('transferOption');
      const pickupAddressInput = document.getElementById('pickupAddress');
      const dropoffAddressInput = document.getElementById('dropoffAddress');
      const transferTimeNoteInput = document.getElementById('transferTimeNote');
      const btnUseCurrentLocation = document.getElementById('btnUseCurrentLocation');
      const mapWrapper = document.getElementById('mapWrapper');
      const mapPreview = document.getElementById('mapPreview');

      if (!transferOptionSelect) {
        return;
      }

      function updateTransferFields() {
        const val = transferOptionSelect.value || 'none';

        const needPickup = val === 'pickup' || val === 'both';
        const needDropoff = val === 'dropoff' || val === 'both';

        if (pickupAddressInput) {
          pickupAddressInput.disabled = !needPickup;
          if (!needPickup) pickupAddressInput.value = '';
        }

        if (dropoffAddressInput) {
          dropoffAddressInput.disabled = !needDropoff;
          if (!needDropoff) dropoffAddressInput.value = '';
        }

        if (transferTimeNoteInput) {
          transferTimeNoteInput.disabled = (val === 'none');
          if (val === 'none') transferTimeNoteInput.value = '';
        }

        if (val === 'none' && mapWrapper) {
          mapWrapper.style.display = 'none';
          if (mapPreview) mapPreview.src = '';
        }
      }

      updateTransferFields();
      transferOptionSelect.addEventListener('change', updateTransferFields);

      if (btnUseCurrentLocation && pickupAddressInput) {
        btnUseCurrentLocation.addEventListener('click', () => {
          if (!navigator.geolocation) {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.');
            return;
          }

          btnUseCurrentLocation.disabled = true;
          btnUseCurrentLocation.textContent = 'ƒêang l·∫•y v·ªã tr√≠...';

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;

              pickupAddressInput.value =
                pickupAddressInput.value && !pickupAddressInput.value.startsWith('V·ªã tr√≠ hi·ªán t·∫°i') ?
                  pickupAddressInput.value :
                  `V·ªã tr√≠ hi·ªán t·∫°i (lat: ${lat.toFixed(5)}, lng: ${lng.toFixed(5)})`;

              if (mapPreview && mapWrapper) {
                const gmapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
                mapPreview.src = gmapUrl;
                mapWrapper.style.display = 'block';
              }

              btnUseCurrentLocation.disabled = false;
              btnUseCurrentLocation.textContent = 'L·∫•y v·ªã tr√≠ c·ªßa t√¥i';
            },
            (err) => {
              console.error('Geolocation error:', err);
              alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. B·∫°n vui l√≤ng b·∫≠t GPS / cho ph√©p truy c·∫≠p v·ªã tr√≠ nh√©.');
              btnUseCurrentLocation.disabled = false;
              btnUseCurrentLocation.textContent = 'L·∫•y v·ªã tr√≠ c·ªßa t√¥i';
            }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          }
          );
        });
      }
    })();
  </script>

  <!-- ========================= SUBMIT + THANH TO√ÅN VNPay / MoMo ========================= -->
  <script>
    /* ===========================================================
       SUBMIT FORM ƒê·∫∂T V√â
    =========================================================== */
    byId('customerForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // ‚ùó CH·∫∂N RELOAD TRANG
      const form = e.currentTarget;

      // Validate Bootstrap
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      if (!holdCtx) return;

      // Ki·ªÉm tra h·∫øt th·ªùi gian gi·ªØ ch·ªó
      const [mm, ss] = (byId('leftTime').textContent || '00:00')
        .split(':').map(Number);
      if ((mm * 60 + ss) <= 0) {
        byId('formMsg').textContent = 'Gi·ªØ ch·ªó ƒë√£ h·∫øt h·∫°n.';
        byId('formMsg').classList.add('text-danger');
        return;
      }

      // Build payload
      const payload = {
        holdId: holdCtx.holdId,
        customer: {
          name: byId('name').value.trim(),
          phone: byId('phone').value.trim(),
          email: byId('email').value.trim() || undefined,
          pickupPoint: byId('pickupPoint').value.trim(),
          dropoffPoint: byId('dropoffPoint').value.trim(),
          note: byId('note').value.trim() || undefined,

          // TH√äM TH√îNG TIN TRUNG CHUY·ªÇN
          transferOption: document.getElementById('transferOption').value,
          pickupAddress: document.getElementById('pickupAddress').value.trim() || undefined,
          dropoffAddress: document.getElementById('dropoffAddress').value.trim() || undefined,
          transferTimeNote: document.getElementById('transferTimeNote').value.trim() || undefined,
        },
        paymentMethod: byId('paymentMethod').value
      };

      byId('formMsg').textContent = '';
      setLoading(true, 'ƒêang x√°c nh·∫≠n ƒë·∫∑t v√©...');

      try {
        const res = await fetch(`${API_BASE}/bookings/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok || data.ok === false) {
          setLoading(false);
          byId('formMsg').classList.add('text-danger');
          byId('formMsg').textContent = data.message || 'ƒê·∫∑t v√© th·∫•t b·∫°i.';
          return;
        }

        // Th√†nh c√¥ng
        clearInterval(timer);
        const bookingId = data.bookingId || data._id;
        const method = payload.paymentMethod;

        // TH1: COD ‚Äì Hi·ªÉn th·ªã k·∫øt qu·∫£ ngay
        if (method === 'cod') {
          const seatCount = holdCtx.seatCodes.length;
          const total = seatCount * holdCtx.priceEach;

          showResult(`
          <p class="fw-bold">ƒê·∫∑t v√© th√†nh c√¥ng! (Thanh to√°n khi l√™n xe)</p>
          <p>M√£ v√©: <span class="mono">${bookingId}</span></p>
          <p>
            Tuy·∫øn: <strong>${ROUTE_LABEL[holdCtx.routeCode]}</strong><br>
            Kh·ªüi h√†nh: <strong>${holdCtx.date}</strong> ‚Ä¢ <strong>${holdCtx.departHM}</strong><br>
            Gh·∫ø: <strong>${holdCtx.seatCodes.join(', ')}</strong><br>
            T·ªïng ti·ªÅn: <strong>${fmtVND(total)}</strong>
          </p>
        `);
          setLoading(false);
          return;
        }

        // TH2: VNPay
        if (method === 'vnpay') {
          setStepActive(4);
          await doVnpayRedirect(bookingId);
          return;
        }

        // TH3: MoMo
        if (method === 'momo') {
          setStepActive(4);
          await doMomoRedirect(bookingId);
          return;
        }

      } catch (err) {
        console.error(err);
        byId('formMsg').classList.add('text-danger');
        byId('formMsg').textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
        setLoading(false);
      }
    });

    /* ===========================================================
       REDIRECT VNPAY
    =========================================================== */
    async function doVnpayRedirect(bookingId) {
      try {
        const amount = Number(byId('totalAmount').dataset.amount || 0);
        const route = ROUTE_LABEL[holdCtx.routeCode];
        const depart = `${holdCtx.date} ‚Ä¢ ${holdCtx.departHM}`;
        const seats = holdCtx.seatCodes.join(', ');
        const name = byId('name').value.trim();
        const phone = byId('phone').value.trim();

        const orderInfo =
          `Ve ${route} ${depart} | Ghe: ${seats} | KH: ${name} | SDT: ${phone}`;

        const resp = await fetch(`${API_BASE}/payment/create_vnpay_url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, orderId: bookingId, orderInfo })
        });

        if (!resp.ok) throw new Error('T·∫°o link VNPay th·∫•t b·∫°i');

        const { paymentUrl } = await resp.json();
        if (!paymentUrl) throw new Error('Kh√¥ng c√≥ paymentUrl');

        window.location.href = paymentUrl; // üöÄ NH·∫¢Y SANG VNPay

      } catch (err) {
        console.error(err);
        setLoading(false);
        byId('formMsg').classList.add('text-danger');
        byId('formMsg').textContent =
          'Kh√¥ng th·ªÉ t·∫°o thanh to√°n VNPay. Th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.';
      }
    }

    /* ===========================================================
       REDIRECT MOMO
    =========================================================== */
    async function doMomoRedirect(bookingId) {
      try {
        const amount = Number(byId('totalAmount').dataset.amount || 0);
        const routeLabel = ROUTE_LABEL[holdCtx.routeCode];
        const seats = holdCtx.seatCodes.join(', ');
        const orderInfo =
          `Ve: ${routeLabel} | Ngay: ${holdCtx.date} | Gio: ${holdCtx.departHM} | Ghe: ${seats}`;

        const resp = await fetch(`${API_BASE}/payment/momo/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, orderId: bookingId, orderInfo })
        });

        if (!resp.ok) throw new Error('T·∫°o link MoMo th·∫•t b·∫°i');

        const data = await resp.json();
        if (!data.payUrl) throw new Error('Kh√¥ng c√≥ payUrl');

        window.location.href = data.payUrl; // üöÄ NH·∫¢Y SANG MOMO

      } catch (err) {
        console.error(err);
        setLoading(false);
        byId('formMsg').classList.add('text-danger');
        byId('formMsg').textContent =
          'Kh√¥ng th·ªÉ t·∫°o thanh to√°n MoMo. Th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.';
      }
    }
  </script>

</body>

</html>
