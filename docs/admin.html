<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Admin | Quản trị hệ thống</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --light-bg: #f8f9fa;
      --dark-text: #212529;
      --light-text: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    body { 
      background: #f0f2f5; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--dark-text);
    }
    
    .container-fluid {
      padding: 0;
    }
    
    .sidebar {
      background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      min-height: 100vh;
      padding: 0;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
    }
    
    .sidebar-header {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-nav {
      padding: 1rem 0;
    }
    
    .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 0.75rem 1.5rem;
      margin: 0.25rem 0.5rem;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .nav-link i {
      margin-right: 0.75rem;
      font-size: 1.1rem;
    }
    
    .nav-link:hover, .nav-link.active {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
    }
    
    .main-content {
      padding: 1.5rem;
    }
    
    .header {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--box-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }
    
    .card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: white;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      padding: 1rem 1.5rem;
      font-weight: 600;
      border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    .table-responsive {
      border-radius: var(--border-radius);
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table thead th {
      background-color: var(--light-bg);
      border-bottom: 1px solid #dee2e6;
      font-weight: 600;
      padding: 0.75rem 1rem;
    }
    
    .table tbody td {
      padding: 0.75rem 1rem;
      vertical-align: middle;
    }
    
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: var(--transition);
      padding: 0.5rem 1rem;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-success {
      background-color: #4caf50;
      border-color: #4caf50;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      border: 1px solid #e0e0e0;
      transition: var(--transition);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }
    
    .badge {
      border-radius: 6px;
      padding: 0.35em 0.65em;
      font-weight: 500;
    }
    
    .status-badge { 
      text-transform: capitalize; 
    }
    
    .small-muted { 
      font-size: 0.875rem; 
      color: var(--light-text); 
    }
    
    .stats-card {
      text-align: center;
      padding: 1.5rem;
    }
    
    .stats-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .stats-label {
      font-size: 0.875rem;
      color: var(--light-text);
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .action-buttons .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        min-height: auto;
        width: 100%;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .action-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 sidebar d-md-block">
      <div class="sidebar-header">
        <h4 class="mb-0"><i class="bi bi-speedometer2"></i> Admin Panel</h4>
      </div>
      <div class="sidebar-nav">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#tabUsers">
              <i class="bi bi-people"></i> Người dùng
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabEmployees">
              <i class="bi bi-person-badge"></i> Nhân viên
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabTrips">
              <i class="bi bi-bus-front"></i> Chuyến xe
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabBookings">
              <i class="bi bi-ticket-perforated"></i> Vé/Booking
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabPayments">
              <i class="bi bi-credit-card"></i> Thanh toán
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tabRevenue">
              <i class="bi bi-graph-up"></i> Doanh thu
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#tabReviews" data-bs-toggle="tab">
              <i class="bi bi-star-half"></i> Đánh giá
            </a>
          </li>
          <li class="nav-item mt-4">
            <a class="nav-link" href="index.html">
              <i class="bi bi-arrow-left"></i> Về trang chủ
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10 main-content">
      <div class="header">
        <h3 class="mb-0">Bảng điều khiển Admin</h3>
        <div class="d-flex align-items-center">
          <span class="me-3 small-muted" id="currentTime"></span>
          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> Tài khoản
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Thông tin</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Cài đặt</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="index.html"><i class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="card stats-card">
            <div class="stats-number" id="statsUsers">0</div>
            <div class="stats-label">Người dùng</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card stats-card">
            <div class="stats-number" id="statsTrips">0</div>
            <div class="stats-label">Chuyến xe</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card stats-card">
            <div class="stats-number" id="statsBookings">0</div>
            <div class="stats-label">Đặt vé</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card stats-card">
            <div class="stats-number" id="statsRevenue">0</div>
            <div class="stats-label">Doanh thu (VNĐ)</div>
          </div>
        </div>
      </div>

      <!-- Tabs content -->
      <div class="tab-content" id="admTabsContent">
        <!-- USERS -->
        <div class="tab-pane fade show active" id="tabUsers">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý người dùng</h5>
              <button id="btnReloadUsers" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Tạo tài khoản admin mới</h6>
                <div class="small-muted" id="msgUsers"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-3">
                  <input id="u-username" class="form-control" placeholder="Tên đăng nhập" />
                </div>
                <div class="col-md-3">
                  <input id="u-email" class="form-control" placeholder="Email (tuỳ chọn)" />
                </div>
                <div class="col-md-3">
                  <input id="u-password" type="password" class="form-control" placeholder="Mật khẩu" />
                </div>
                <div class="col-md-3 d-grid">
                  <button id="btnCreateAdmin" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Tạo admin
                  </button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Tên đăng nhập</th>
                      <th>Email</th>
                      <th>Vai trò</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbUsers"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- EMPLOYEES -->
        <div class="tab-pane fade" id="tabEmployees">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý nhân viên</h5>
              <button id="btnReloadEmployees" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Thêm nhân viên</h6>
                <div class="small-muted" id="msgEmployees"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-3">
                  <input id="e-username" class="form-control" placeholder="Tên đăng nhập" />
                </div>
                <div class="col-md-3">
                  <input id="e-name" class="form-control" placeholder="Tên hiển thị" />
                </div>
                <div class="col-md-3">
                  <input id="e-password" type="password" class="form-control" placeholder="Mật khẩu" />
                </div>
                <div class="col-md-3 d-grid">
                  <button id="btnCreateEmployee" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Thêm nhân viên
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Tên đăng nhập</th>
                      <th>Tên</th>
                      <th>Vai trò</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbEmployees"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="tab-pane fade" id="tabTrips">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý chuyến xe</h5>
              <button id="btnTripReload" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Lọc chuyến xe</h6>
                <div class="small-muted" id="msgTrips"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-2">
                  <input id="t-route" class="form-control" placeholder="Mã tuyến">
                </div>
                <div class="col-md-2">
                  <input id="t-date" type="date" class="form-control">
                </div>
                <div class="col-md-2">
                  <select id="t-active" class="form-select">
                    <option value="">Tất cả</option>
                    <option value="true">Đang mở</option>
                    <option value="false">Đã tắt</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button id="btnTripFilter" class="btn btn-primary w-100">Lọc</button>
                </div>
              </div>
              
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Tạo chuyến xe mới</h6>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-2">
                  <input id="nt-route" class="form-control" placeholder="Mã tuyến">
                </div>
                <div class="col-md-2">
                  <input id="nt-dateStr" type="date" class="form-control">
                </div>
                <div class="col-md-2">
                  <input id="nt-departHM" class="form-control" placeholder="Giờ khởi hành (HH:mm)">
                </div>
                <div class="col-md-2">
                  <input id="nt-price" type="number" class="form-control" placeholder="Giá vé">
                </div>
                <div class="col-md-2">
                  <input id="nt-seats" type="number" class="form-control" placeholder="Số ghế">
                </div>
                <div class="col-md-2 d-grid">
                  <button id="btnTripCreate" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Tạo
                  </button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Mã tuyến</th>
                      <th>Ngày</th>
                      <th>Giờ khởi hành</th>
                      <th>Giá vé</th>
                      <th>Ghế</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbTrips"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- BOOKINGS -->
        <div class="tab-pane fade" id="tabBookings">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý vé đặt</h5>
              <button id="btnBookingReload" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Lọc vé đặt</h6>
                <div class="small-muted" id="msgBookings"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-3">
                  <input id="b-q" class="form-control" placeholder="Tìm tên/sđt/email/mã vé">
                </div>
                <div class="col-md-3">
                  <input id="b-from" type="date" class="form-control" placeholder="Từ ngày">
                </div>
                <div class="col-md-3">
                  <input id="b-to" type="date" class="form-control" placeholder="Đến ngày">
                </div>
                <div class="col-md-2">
                  <button id="btnBookingFilter" class="btn btn-primary w-100">Lọc</button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Khách hàng</th>
                      <th>Mã chuyến</th>
                      <th>Ghế</th>
                      <th>Trạng thái</th>
                      <th>Thanh toán</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbBookings"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- PAYMENTS -->
        <div class="tab-pane fade" id="tabPayments">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý thanh toán</h5>
              <button id="btnPaymentReload" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Lọc thanh toán</h6>
                <div class="small-muted" id="msgPayments"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-3">
                  <select id="p-status" class="form-select">
                    <option value="">Tất cả trạng thái</option>
                    <option>pending</option>
                    <option>paid</option>
                    <option>failed</option>
                    <option>refunded</option>
                    <option>expired</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <input id="p-from" type="date" class="form-control" placeholder="Từ ngày">
                </div>
                <div class="col-md-3">
                  <input id="p-to" type="date" class="form-control" placeholder="Đến ngày">
                </div>
                <div class="col-md-2">
                  <button id="btnPaymentFilter" class="btn btn-primary w-100">Lọc</button>
                </div>
              </div>
              
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>Mã đặt vé</th>
                      <th>Phương thức</th>
                      <th>Số tiền</th>
                      <th>Trạng thái</th>
                      <th>Ngày tạo</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbPayments"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- REVENUE -->
        <div class="tab-pane fade" id="tabRevenue">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Báo cáo doanh thu</h5>
              <button id="btnRevenueReload" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Tùy chọn báo cáo</h6>
                <div class="small-muted" id="msgRevenue"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-3">
                  <input id="r-from" type="date" class="form-control" placeholder="Từ ngày">
                </div>
                <div class="col-md-3">
                  <input id="r-to" type="date" class="form-control" placeholder="Đến ngày">
                </div>
                <div class="col-md-2">
                  <select id="r-group" class="form-select">
                    <option value="day">Theo ngày</option>
                    <option value="month">Theo tháng</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button id="btnRevenueFilter" class="btn btn-primary w-100">Tải báo cáo</button>
                </div>
              </div>
              
              <div class="row g-3">
                <div class="col-lg-5">
                  <div class="card h-100">
                    <div class="card-header">
                      <h6 class="mb-0">Tổng quan</h6>
                    </div>
                    <div class="card-body">
                      <div id="revSummary" class="small-muted">—</div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-7">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">Doanh thu theo mốc thời gian</h6>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead class="table-light">
                            <tr>
                              <th>Mốc</th>
                              <th>Đơn</th>
                              <th>Doanh thu</th>
                            </tr>
                          </thead>
                          <tbody id="tbRevByDate"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="card mt-3">
                    <div class="card-header">
                      <h6 class="mb-0">Doanh thu theo tuyến</h6>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead class="table-light">
                            <tr>
                              <th>Mã tuyến</th>
                              <th>Vé</th>
                              <th>Doanh thu</th>
                            </tr>
                          </thead>
                          <tbody id="tbRevByRoute"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- REVIEWS -->
        <div class="tab-pane fade" id="tabReviews">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Quản lý đánh giá</h5>
              <button id="btnReviewReload" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
              </button>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h6 class="mb-0">Lọc đánh giá</h6>
                <div class="small-muted" id="msgReviews"></div>
              </div>
              <div class="row g-2 mb-4">
                <div class="col-md-4">
                  <input id="rv-phone" class="form-control" placeholder="Số điện thoại khách hàng">
                </div>
                <div class="col-md-4">
                  <input id="rv-tripId" class="form-control" placeholder="ID chuyến (tuỳ chọn)">
                </div>
                <div class="col-md-2">
                  <button id="btnReviewFilter" class="btn btn-primary w-100">Lọc</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead class="table-light">
                    <tr>
                      <th>Thời gian</th>
                      <th>Khách hàng</th>
                      <th>Rating</th>
                      <th>Bình luận</th>
                      <th>Chuyến</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="tbReviews"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /tab-content -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- CONFIG DÙNG CHUNG: API_BASE = https://webdatve.onrender.com -->
<script src="config.js"></script>

<script>
/* ===== CONFIG ===== */
/* API_BASE đã được khai báo trong config.js – không khai báo lại ở đây */
// const API_BASE = 'http://127.0.0.1:3000';
const token = () => localStorage.getItem('token');
const H = () => ({ 'Content-Type':'application/json', Authorization: 'Bearer ' + token() });
const $ = (s) => document.querySelector(s);

/* ===== Guard: chỉ admin mới vào ===== */
(async function guard() {
  try {
    const res = await fetch(`${API_BASE}/api/auth/me`, { headers: H(), credentials:'include' });
    if (!res.ok) throw 0;
    const me = await res.json();
    if (me.role !== 'admin') {
      alert('Bạn không có quyền admin');
      location.href = 'index.html';
    }
  } catch {
    alert('Hết phiên đăng nhập, vui lòng đăng nhập lại');
    location.href = 'login.html';
  }
})();

/* ===== Helper ===== */
const fmtMoney = n => (Number(n||0)).toLocaleString('vi-VN');
const setMsg = (selector, text, ok=true) => { 
  const el=$(selector); 
  if(!el) return; 
  el.textContent=text||''; 
  el.className = ok?'small-muted text-success':'small-muted text-danger'; 
};

/* ===== Update Current Time ===== */
function updateTime() {
  const now = new Date();
  const options = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  };
  $('#currentTime').textContent = now.toLocaleDateString('vi-VN', options);
}
setInterval(updateTime, 1000);
updateTime();

/* ===== Stats Overview ===== */
async function updateStats() {
  try {
    const usersRes = await fetch(`${API_BASE}/api/admin/users`, { headers: H(), credentials:'include' });
    if (usersRes.ok) {
      const usersData = await usersRes.json();
      $('#statsUsers').textContent = usersData.length || 0;
    }
    
    const tripsRes = await fetch(`${API_BASE}/api/admin/trips`, { headers: H(), credentials:'include' });
    if (tripsRes.ok) {
      const tripsData = await tripsRes.json();
      $('#statsTrips').textContent = tripsData.total || 0;
    }
    
    const bookingsRes = await fetch(`${API_BASE}/api/admin/bookings`, { headers: H(), credentials:'include' });
    if (bookingsRes.ok) {
      const bookingsData = await bookingsRes.json();
      $('#statsBookings').textContent = bookingsData.total || 0;
    }
    
    const revenueRes = await fetch(`${API_BASE}/api/admin/revenue`, { headers: H(), credentials:'include' });
    if (revenueRes.ok) {
      const revenueData = await revenueRes.json();
      $('#statsRevenue').textContent = fmtMoney(revenueData.summary?.total || 0);
    }
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

/* ===== USERS ===== */
async function reloadUsers(){
  setMsg('#msgUsers','Đang tải...');
  const r = await fetch(`${API_BASE}/api/admin/users`, { headers: H(), credentials:'include' });
  const data = await r.json();
  if(!r.ok){ setMsg('#msgUsers', data.message || 'Lỗi tải danh sách', false); return; }
  $('#tbUsers').innerHTML = (data||[]).map(u=>`
    <tr>
      <td class="small">${u._id}</td>
      <td>${u.username||''}</td>
      <td>${u.email||''}</td>
      <td><span class="badge ${u.role==='admin'?'bg-danger':u.role==='employee'?'bg-warning text-dark':'bg-secondary'}">${u.role}</span></td>
      <td>
        <div class="action-buttons">
          <select class="form-select form-select-sm" id="role-${u._id}">
            <option value="customer" ${u.role==='customer'?'selected':''}>customer</option>
            <option value="employee" ${u.role==='employee'?'selected':''}>employee</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          </select>
          <button class="btn btn-sm btn-primary" onclick="changeRole('${u._id}')">
            <i class="bi bi-arrow-repeat"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="delUser('${u._id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    </tr>`).join('');
  setMsg('#msgUsers', `Đã tải ${data.length} người dùng`, true);
  updateStats();
}
async function createAdmin(){
  const username = $('#u-username').value.trim().toLowerCase();
  const email = $('#u-email').value.trim().toLowerCase() || undefined;
  const password = $('#u-password').value;
  if(!username || !password) return setMsg('#msgUsers','Thiếu username/password', false);
  const r = await fetch(`${API_BASE}/api/admin/users`, { method:'POST', headers:H(), credentials:'include', body:JSON.stringify({ username, email, password }) });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgUsers', d.message||'Tạo admin thất bại', false);
  setMsg('#msgUsers','Tạo admin thành công', true);
  $('#u-username').value=''; $('#u-email').value=''; $('#u-password').value='';
  reloadUsers();
}
async function changeRole(id){
  const role = document.getElementById('role-'+id).value;
  const r = await fetch(`${API_BASE}/api/admin/users/${id}/role`, { method:'PATCH', headers:H(), credentials:'include', body:JSON.stringify({ role })});
  const d = await r.json();
  if(!r.ok) return setMsg('#msgUsers', d.message||'Đổi role thất bại', false);
  setMsg('#msgUsers','Đã đổi role', true);
  reloadUsers();
}
async function delUser(id){
  if(!confirm('Xoá user này?')) return;
  const r = await fetch(`${API_BASE}/api/admin/users/${id}`, { method:'DELETE', headers:H(), credentials:'include' });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgUsers', d.message||'Xoá thất bại', false);
  setMsg('#msgUsers','Đã xoá user', true);
  reloadUsers();
}
window.changeRole = changeRole;
window.delUser = delUser;

/* ===== EMPLOYEES ===== */
async function reloadEmployees(){
  setMsg('#msgEmployees','Đang tải...');
  const r = await fetch(`${API_BASE}/api/admin/users`, { headers: H(), credentials:'include' });
  const data = await r.json();
  if(!r.ok){ setMsg('#msgEmployees', data.message || 'Lỗi tải danh sách', false); return; }
  const employees = (data||[]).filter(u => u.role === 'employee');
  $('#tbEmployees').innerHTML = employees.map(u=>`
    <tr>
      <td class="small">${u._id}</td>
      <td>${u.username||''}</td>
      <td>${u.email||''}</td>
      <td><span class="badge bg-warning text-dark">employee</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-outline-danger" onclick="delUser('${u._id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    </tr>`).join('') || '<tr><td colspan="5" class="text-center text-muted">Chưa có nhân viên</td></tr>';
  setMsg('#msgEmployees', `Đã tải ${employees.length} nhân viên`, true);
}
async function createEmployee(){
  const username = $('#e-username').value.trim().toLowerCase();
  const name = $('#e-name').value.trim();
  const password = $('#e-password').value;
  if(!username || !password) return setMsg('#msgEmployees','Thiếu username/password', false);

  const r = await fetch(`${API_BASE}/api/admin/users`, {
    method:'POST', headers:H(), credentials:'include',
    body:JSON.stringify({ username, email: name, password, role:'employee' })
  });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgEmployees', d.message||'Tạo nhân viên thất bại', false);
  setMsg('#msgEmployees','Đã tạo nhân viên', true);
  $('#e-username').value=''; $('#e-name').value=''; $('#e-password').value='';
  reloadEmployees();
  reloadUsers();
}

/* ===== TRIPS ===== */
async function reloadTrips(){
  setMsg('#msgTrips','Đang tải...');
  const qs = new URLSearchParams();
  const rc = $('#t-route').value.trim(); if(rc) qs.set('routeCode', rc);
  const ds = $('#t-date').value; if(ds) qs.set('dateStr', ds);
  const act = $('#t-active').value; if(act) qs.set('active', act);
  const r = await fetch(`${API_BASE}/api/admin/trips?` + qs.toString(), { headers:H(), credentials:'include' });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgTrips', d.message||'Lỗi tải', false);
  $('#tbTrips').innerHTML = (d.items||[]).map(t=>`
    <tr>
      <td class="small">${t._id}</td>
      <td>${t.routeCode}</td>
      <td>${t.dateStr}</td>
      <td>${t.departHM||''}</td>
      <td>${fmtMoney(t.price)}</td>
      <td>${(t.seatsBooked||[]).length}/${t.seatsTotal||0}</td>
      <td>${t.active?'<span class="badge bg-success">on</span>':'<span class="badge bg-secondary">off</span>'}</td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-outline-primary" onclick="toggleTrip('${t._id}', ${!t.active})">
            ${t.active?'<i class="bi bi-pause"></i>':'<i class="bi bi-play"></i>'}
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="delTrip('${t._id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </td>
    </tr>`).join('');
  setMsg('#msgTrips', `Tổng: ${d.total}`, true);
  updateStats();
}
async function createTrip(){
  const payload = {
    routeCode: $('#nt-route').value.trim(),
    dateStr: $('#nt-dateStr').value,
    departHM: $('#nt-departHM').value.trim(),
    price: Number($('#nt-price').value),
    seatsTotal: Number($('#nt-seats').value),
  };
  if(!payload.routeCode || !payload.dateStr || !payload.departHM || !payload.price || !payload.seatsTotal)
    return setMsg('#msgTrips','Thiếu thông tin tạo chuyến', false);
  const r = await fetch(`${API_BASE}/api/admin/trips`, { method:'POST', headers:H(), credentials:'include', body:JSON.stringify(payload) });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgTrips', d.message||'Tạo chuyến thất bại', false);
  setMsg('#msgTrips','Đã tạo chuyến', true);
  reloadTrips();
}
async function toggleTrip(id, active){
  const r = await fetch(`${API_BASE}/api/admin/trips/${id}`, { method:'PATCH', headers:H(), credentials:'include', body:JSON.stringify({ active }) });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgTrips', d.message||'Cập nhật thất bại', false);
  reloadTrips();
}
async function delTrip(id){
  if(!confirm('Xoá chuyến này?')) return;
  const r = await fetch(`${API_BASE}/api/admin/trips/${id}`, { method:'DELETE', headers:H(), credentials:'include' });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgTrips', d.message||'Xoá thất bại', false);
  reloadTrips();
}
window.toggleTrip = toggleTrip;
window.delTrip = delTrip;

/* ===== BOOKINGS ===== */
async function reloadBookings(){
  setMsg('#msgBookings','Đang tải...');
  const qs = new URLSearchParams();
  const q = $('#b-q').value.trim(); if(q) qs.set('q', q);
  const f = $('#b-from').value; if(f) qs.set('from', f);
  const t = $('#b-to').value; if(t) qs.set('to', t);
  const r = await fetch(`${API_BASE}/api/admin/bookings?` + qs.toString(), { headers:H(), credentials:'include' });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgBookings', d.message||'Lỗi tải', false);
  $('#tbBookings').innerHTML = (d.items||[]).map(b=>`
    <tr>
      <td class="small">${b._id}</td>
      <td>${b.customer?.name||''}<div class="small-muted">${b.customer?.phone||''} · ${b.customer?.email||''}</div></td>
      <td class="small">${b.tripId||''}</td>
      <td>${(b.seatCodes||[]).join(', ')}</td>
      <td><span class="badge bg-info text-dark status-badge">${b.status||''}</span></td>
      <td>${b.payment?.method||''}<div class="small-muted">${b.payment?.status||''} · ${fmtMoney(b.payment?.amount||0)}</div></td>
      <td>
        <div class="action-buttons">
          <select id="bk-status-${b._id}" class="form-select form-select-sm">
            <option ${b.status==='pending'?'selected':''}>pending</option>
            <option ${b.status==='confirmed'?'selected':''}>confirmed</option>
            <option ${b.status==='cancelled'?'selected':''}>cancelled</option>
            <option ${b.status==='completed'?'selected':''}>completed</option>
          </select>
          <button class="btn btn-sm btn-primary" onclick="updateBookingStatus('${b._id}')">
            <i class="bi bi-check-lg"></i>
          </button>
        </div>
      </td>
    </tr>`).join('');
  setMsg('#msgBookings', `Tổng: ${d.total}`, true);
  updateStats();
}
async function updateBookingStatus(id){
  const status = document.getElementById('bk-status-'+id).value;
  const r = await fetch(`${API_BASE}/api/admin/bookings/${id}/status`, { method:'PATCH', headers:H(), credentials:'include', body:JSON.stringify({ status }) });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgBookings', d.message||'Cập nhật thất bại', false);
  setMsg('#msgBookings', 'Đã cập nhật', true);
  reloadBookings();
}
window.updateBookingStatus = updateBookingStatus;

/* ===== PAYMENTS ===== */
async function reloadPayments(){
  setMsg('#msgPayments','Đang tải...');
  const qs = new URLSearchParams();
  const st = $('#p-status').value; if(st) qs.set('status', st);
  const f = $('#p-from').value; if(f) qs.set('from', f);
  const t = $('#p-to').value; if(t) qs.set('to', t);

  qs.set('_', Date.now());

  const r = await fetch(`${API_BASE}/api/admin/payments?` + qs.toString(), { 
    headers: H(), 
    credentials: 'include',
    cache: 'no-store'
  });

  if (r.status === 304) {
    setMsg('#msgPayments', 'Không có thay đổi mới', true);
    return;
  }

  const raw = await r.text();
  let d = {};
  try { d = raw ? JSON.parse(raw) : {}; } catch(e) { d = {}; }

  if(!r.ok) return setMsg('#msgPayments', d.message||'Lỗi tải', false);

  const items = Array.isArray(d.items) ? d.items : [];

  $('#tbPayments').innerHTML = (items||[]).map(p=>`
    <tr>
      <td class="small">${p._id}</td>
      <td class="small">${p.bookingInfo?.bookingId || p.bookingId || ''}</td>
      <td>${p.method||''}</td>
      <td>${fmtMoney(p.amount||0)}</td>
      <td><span class="badge bg-secondary status-badge">${p.status}</span></td>
      <td class="small">${p.createdAt ? new Date(p.createdAt).toLocaleString('vi-VN') : ''}</td>
      <td>
        <div class="action-buttons">
          <select id="pay-status-${p._id}" class="form-select form-select-sm">
            ${['pending','paid','failed','refunded','expired','cancelled'].map(s=>`<option ${p.status===s?'selected':''}>${s}</option>`).join('')}
          </select>
          <button class="btn btn-sm btn-primary" onclick="updatePaymentStatus('${p._id}')">
            <i class="bi bi-check-lg"></i>
          </button>
        </div>
      </td>
    </tr>`).join('') || `<tr><td colspan="7" class="text-center text-muted">Chưa có dữ liệu</td></tr>`;

  setMsg('#msgPayments', `Tổng: ${d.total||0}`, true);
  updateStats();
}
async function updatePaymentStatus(id){
  const status = document.getElementById('pay-status-'+id).value;
  const r = await fetch(`${API_BASE}/api/admin/payments/${id}/status`, { method:'PATCH', headers:H(), credentials:'include', body:JSON.stringify({ status }) });
  const d = await r.json();
  if(!r.ok) return setMsg('#msgPayments', d.message||'Cập nhật thất bại', false);
  setMsg('#msgPayments', 'Đã cập nhật', true);
  reloadPayments();
}
window.updatePaymentStatus = updatePaymentStatus;

/* ===== REVENUE ===== */
async function reloadRevenue(){
  setMsg('#msgRevenue','Đang tổng hợp...');
  const qs = new URLSearchParams();
  const f = $('#r-from').value; if(f) qs.set('from', f);
  const t = $('#r-to').value; if(t) qs.set('to', t);
  const g = $('#r-group').value; if(g) qs.set('groupBy', g);

  const r1 = await fetch(`${API_BASE}/api/admin/revenue?` + qs.toString(), { headers:H(), credentials:'include' });
  const rev = await r1.json();
  if(!r1.ok) return setMsg('#msgRevenue', rev.message||'Lỗi tổng hợp', false);
  $('#revSummary').innerHTML = `
    <div>Tổng doanh thu: <b>${fmtMoney(rev.summary?.total||0)}</b></div>
    <div>Tổng đơn: <b>${rev.summary?.orders||0}</b></div>
  `;
  $('#tbRevByDate').innerHTML = (rev.byDate||[]).map(x=>`
    <tr><td>${x._id}</td><td>${x.orders}</td><td>${fmtMoney(x.total)}</td></tr>
  `).join('');

  const r2 = await fetch(`${API_BASE}/api/admin/revenue/by-route?` + qs.toString(), { headers:H(), credentials:'include' });
  const byRoute = await r2.json();
  if(!r2.ok) return setMsg('#msgRevenue', byRoute.message||'Lỗi tuyến', false);
  $('#tbRevByRoute').innerHTML = (byRoute||[]).map(x=>`
    <tr><td>${x.routeCode}</td><td>${x.tickets}</td><td>${fmtMoney(x.revenue)}</td></tr>
  `).join('');
  setMsg('#msgRevenue','Đã cập nhật', true);
  updateStats();
}

/* ===== REVIEWS ===== */
async function reloadReviews(){
  setMsg('#msgReviews','Đang tải...');
  const qs = new URLSearchParams();
  const phoneEl = $('#rv-phone');
  const tripEl = $('#rv-tripId');
  const phone = phoneEl ? phoneEl.value.trim() : '';
  const tripId = tripEl ? tripEl.value.trim() : '';

  if (phone) qs.set('phone', phone);
  if (tripId) qs.set('tripId', tripId);

  const r = await fetch(`${API_BASE}/api/admin/reviews?` + qs.toString(), { headers: H(), credentials:'include' });
  const d = await r.json();
  if (!r.ok) {
    setMsg('#msgReviews', d.message || 'Lỗi tải danh sách', false);
    return;
  }

  const items = Array.isArray(d.items) ? d.items : (Array.isArray(d) ? d : []);

  if (!items.length) {
    $('#tbReviews').innerHTML = '<tr><td colspan="6" class="text-center text-muted">Chưa có đánh giá</td></tr>';
    setMsg('#msgReviews', 'Chưa có đánh giá', true);
    return;
  }

  $('#tbReviews').innerHTML = items.map(rv => {
    const created = rv.createdAt ? new Date(rv.createdAt).toLocaleString('vi-VN') : '';
    const rating = Number(rv.rating || 0);
    const safeRating = Math.max(1, Math.min(5, rating));
    const stars = '★'.repeat(safeRating) + '☆'.repeat(5 - safeRating);
    const trip = rv.tripId || {};
    const tripInfo = trip ? `${trip.routeCode || ''}` : '';

    return `
      <tr>
        <td class="small">${created}</td>
        <td>
          ${rv.name || ''}
          <div class="small-muted">${rv.phone || ''}</div>
        </td>
        <td>
          <span>${safeRating}/5</span>
          <div class="small-muted">${stars}</div>
        </td>
        <td>${rv.comment || ''}</td>
        <td>
          ${tripInfo || '—'}
          <div class="small-muted">
            ${(trip.dateStr || '')} ${(trip.departHM || '')}
          </div>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-outline-danger" onclick="delReview('${rv._id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  setMsg('#msgReviews', `Đã tải ${items.length} đánh giá`, true);
}

async function delReview(id){
  if (!confirm('Xoá đánh giá này?')) return;
  const r = await fetch(`${API_BASE}/api/admin/reviews/${id}`, { method:'DELETE', headers: H(), credentials:'include' });
  const d = await r.json();
  if (!r.ok) {
    setMsg('#msgReviews', d.message || 'Xoá đánh giá thất bại', false);
    return;
  }
  setMsg('#msgReviews','Đã xoá đánh giá', true);
  reloadReviews();
}
window.delReview = delReview;

/* ===== Bind buttons ===== */
document.addEventListener('DOMContentLoaded', () => {
  // Users
  $('#btnReloadUsers').onclick = reloadUsers;
  $('#btnCreateAdmin').onclick = createAdmin;
  // Employees
  $('#btnReloadEmployees').onclick = reloadEmployees;
  $('#btnCreateEmployee').onclick = createEmployee;
  // Trips
  $('#btnTripReload').onclick = reloadTrips;
  $('#btnTripFilter').onclick = reloadTrips;
  $('#btnTripCreate').onclick = createTrip;
  // Bookings
  $('#btnBookingReload').onclick = reloadBookings;
  $('#btnBookingFilter').onclick = reloadBookings;
  // Payments
  $('#btnPaymentReload').onclick = reloadPayments;
  $('#btnPaymentFilter').onclick = reloadPayments;
  // Revenue
  $('#btnRevenueReload').onclick = reloadRevenue;
  $('#btnRevenueFilter').onclick = reloadRevenue;
  // Reviews
  const btnRevReload = $('#btnReviewReload');
  const btnRevFilter = $('#btnReviewFilter');
  if (btnRevReload) btnRevReload.onclick = reloadReviews;
  if (btnRevFilter) btnRevFilter.onclick = reloadReviews;

  // Tải mặc định
  reloadUsers();
  reloadEmployees();
  updateStats();
  reloadReviews();
});
</script>
</body>
</html>
